<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head>


  
  <meta http-equiv="CONTENT-TYPE" content="text/html; charset=utf-8"><title>iMosflm Tutorial</title>
  

  
  
  <meta name="GENERATOR" content="OpenOffice.org 3.2  (Unix)">

  
  <meta name="CREATED" content="20110120;10043700">

  
  <meta name="CHANGEDBY" content="Owen 19042010">

  
  <meta name="CHANGED" content="20111219;13572600">

  
  <meta name="CHANGEDBY" content="Owen 19042010">

  
  <meta name="CHANGEDBY" content="Owen 19042010">

  
  <meta name="CHANGEDBY" content="Owen 19042010"><!--#set var="calling" value="${DOCUMENT_NAME}" --><!--#include file="basic_frame.html" -->


  
  <style type="text/css">
	<!--
		PRE.cjk { font-family: "DejaVu LGC Sans Mono", monospace }
		PRE.ctl { font-family: "Lohit Devanagari", monospace }
		H2.ctl { font-family: "Lohit Devanagari" }
		A:link { color: #000000 }
		A:visited { color: #000000 }
	-->
	</style></head><body dir="ltr" lang="en-GB" link="#000000" vlink="#000000">
<div style="text-align: center;"><big><big><big><font face="Times New Roman, serif">iMosflm
Tutorial<br>
<small>for version 7.4.0 January 2021</small><br>
</font></big></big></big>
</div>

<br>

<big><big>Table of Contents</big></big><br>

<ul id="mozToc">

<!--mozToc h1 1 h2 2 h3 3 h4 4 h5 5 h6 6-->
  <li><a href="#mozTocId29715">1.
Introduction</a>
    <ul>
      <li><a href="#mozTocId534381">1.1
Background</a></li>
      <li><a href="#mozTocId827268">1.2
Installation</a></li>
      <li><a href="#mozTocId410751">1.3
Documentation</a></li>
      <li><a href="#mozTocId816121">1.4
Aims of the tutorial</a></li>
      <li><a href="#mozTocId689712">1.5 Mouse and key
functions </a></li>
    </ul>
  </li>
  <li><a href="#mozTocId360577">2. Overview
of iMosflm</a>
    <ul>
      <li><a href="#mozTocId626255">2.1
Drop Down menus</a></li>
    </ul>
  </li>
  <li><a href="#mozTocId486119">3. Adding
images to a session</a>
    <ul>
      <li><a href="#mozTocId215473">3.1 Summing images
when reading hdf5 files (chunking) </a></li>
    </ul>
  </li>
  <li><a href="#mozTocId44996">4. Image
Display</a>
    <ul>
      <li><a href="#mozTocId114918">4.1
Display Icons</a>
        <ul>
          <li><a href="#mozTocId74027">4.1.1
Masked areas - circular backstop shadow</a></li>
          <li><a href="#mozTocId23713">4.1.2
Masked areas - general exclusions</a></li>
          <li><a href="#mozTocId209370">4.1.3 Spot
search area</a></li>
          <li><a href="#mozTocId890852">4.1.4
Resolution limits</a></li>
          <li><a href="#mozTocId746242">4.1.5 Zooming
and Panning</a></li>
          <li><a href="#mozTocId310974">4.1.6
Circle fitting</a></li>
          <li><a href="#mozTocId822853">4.1.7 Phi
profile</a></li>
        </ul>
      </li>
    </ul>
  </li>
  <li><a href="#mozTocId150573">5. Spot
finding, indexing and mosaicity estimation</a>
    <ul>
      <li><a href="#mozTocId591049">5.1
Spot Finding</a>
        <ul>
          <li><a href="#mozTocId495561">5.1.1
If the spot finding has not worked well </a></li>
        </ul>
      </li>
      <li><a href="#mozTocId325663">5.2
Indexing</a>
        <ul>
          <li><a href="#mozTocId798805">5.2.1
If the indexing fails - Direct beam search</a></li>
          <li><a href="#mozTocId960714">5.2.2
If the indexing fails - Other parameters.</a></li>
        </ul>
      </li>
      <li><a href="#mozTocId189423">5.3 Indexing
multiple lattices simultaneously</a>
        <ul>
          <li><a href="#mozTocId774580">5.3.1
Practical Tips</a></li>
        </ul>
      </li>
      <li><a href="#mozTocId863376">5.4 Known
cell option</a></li>
      <li><a href="#mozTocId368904">5.5
Space group selection</a></li>
      <li><a href="#mozTocId878705">5.6
Mosaicity estimation</a>
        <ul>
          <li><a href="#mozTocId5079">5.6.1
The mosaic block size</a></li>
          <li><a href="#mozTocId431248">5.6.2 The phi profile</a></li>
        </ul>
      </li>
    </ul>
  </li>
  <li><a href="#mozTocId958696">6. Saving and
recovering a session</a></li>
  <li><a href="#mozTocId38147">7. Data
collection strategy</a>
    <ul>
      <li><a href="#mozTocId646178">7.1
Evaluating completeness manually</a></li>
      <li><a href="#mozTocId581133">7.2
Calculating a strategy automatically</a></li>
      <li><a href="#mozTocId750492">7.3
Calculating a strategy using multiple crystals</a>
        <ul>
          <li><a href="#mozTocId126775">7.3.1 Calculating a
strategy when some data have already been collected and processed</a></li>
        </ul>
      </li>
      <li><a href="#mozTocId992584">7.4
Calculating a suitable oscillation angle</a></li>
    </ul>
  </li>
  <li><a href="#mozTocId610524">8. Cell
refinement</a>
    <ul>
      <li><a href="#mozTocId853572">8.1
Selecting the images</a>
        <ul>
          <li><a href="#mozTocId721787">8.1.1
Manual selection</a></li>
          <li><a href="#mozTocId716779">8.1.2
Automatic selection</a></li>
          <li><a href="#mozTocId766179">8.1.3
Graphical selection (Not recommended)</a></li>
        </ul>
      </li>
      <li><a href="#mozTocId639269">8.2
Integrating the images and refining the cell</a>
        <ul>
          <li><a href="#mozTocId109529">8.2.1
The detector parameters window</a></li>
          <li><a href="#mozTocId251279">8.2.2
The crystal parameters window</a></li>
          <li><a href="#mozTocId957382">8.2.3
The central spot profile</a></li>
          <li><a href="#mozTocId943675">8.2.4
The summary window</a></li>
          <li><a href="#mozTocId657403">8.2.5
The final results</a></li>
        </ul>
      </li>
      <li><a href="#mozTocId325680">8.3 Refining cell parameters for
multiple
lattices</a></li>
      <li><a href="#mozTocId775517">8.4 If the
prediction for the first image of a segment is poor</a></li>
    </ul>
  </li>
  <li><a href="#mozTocId907047">9. Integration</a>
    <ul>
      <li><a href="#mozTocId261793">9.1
Image selection</a></li>
      <li><a href="#mozTocId647795">9.2
Setting the MTZ filename and controlling updating of the image
display</a></li>
      <li><a href="#mozTocId164196">9.3
Integrating the images</a></li>
      <li><a href="#mozTocId820258">9.4
Parameter display windows</a></li>
      <li><a href="#mozTocId595790">9.5 Integrating the whole dataset</a>
        <ul>
          <li><a href="#mozTocId15993">9.5.1 Parallel Integration Using
multiple cores</a></li>
          <li><a href="#mozTocId245100">9.5.2
Integrating as a background job</a></li>
        </ul>
      </li>
      <li><a href="#mozTocId905962">9.6
Checking the integration</a></li>
      <li><a href="#mozTocId324820">9.7
Advanced features for integration</a></li>
      <li><a href="#mozTocId906112">9.8
Integrating multiple lattices</a></li>
    </ul>
  </li>
  <li><a href="#mozTocId868502">10. Running
Pointless to check the symmetry</a></li>
  <li><a href="#mozTocId420086">11. Running
Aimless to scale and merge the data</a></li>
  <li><a href="#mozTocId49119">12. History
and mosflm log file</a></li>
  <li><a href="#mozTocId112431">13. Warning
Messages</a></li>
  <li><a href="#mozTocId251449">14. Useful command line options</a>
    <ul>
      <li><a href="#mozTocId323598">14.1 The site file</a></li>
    </ul>
  </li>
  <li><a href="#mozTocId979076">15. The mosflm SUMMARY file</a></li>
  <li><a href="#mozTocId464596">16. Scaling
data with CCP4i</a>
    <ul>
      <li><a href="#mozTocId16713">16.1
Looking at the AIMLESS output</a></li>
    </ul>
  </li>
  <li><a href="#mozTocId44933">17. Changing
the symmetry</a></li>
  <li><a href="#mozTocId252763">18. Looking
at the CTRUNCATE output</a></li>
  <li><a href="#mozTocId991006">19. If you
have time ...</a>
    <ul>
      <li><a href="#mozTocId52124">19.1
Different mosaic spreads</a></li>
      <li><a href="#mozTocId530274">19.2
Checking up on outliers</a></li>
      <li><a href="#mozTocId364567">19.3
How accurate does the unit cell have to be?</a></li>
    </ul>
  </li>
  <li><a href="#mozTocId727216">20. Tips</a></li>
  <li><a href="#mozTocId654806">21. Known Bugs</a></li>
  <li><a href="#mozTocId11307">22. Processing Electron Diffraction
images</a></li>
  <li><a href="#mozTocId154054">Appendix I</a></li>
</ul>

<br>

<h1><a class="mozTocH1" name="mozTocId29715"></a><font face="Times New Roman, serif">1.
Introduction</font></h1>

<h2><a class="mozTocH2" name="mozTocId534381"></a><font face="Times New Roman, serif"><font size="4"><b>1.1
Background</b></font></font></h2>

<p>MOSFLM can process diffraction images from a wide range of
detectors and produces, as output, an MTZ file of reflection indices
with their intensities and standard deviations (and other
parameters). This MTZ file is passed onto other programs of the CCP4
program suite (POINTLESS, AIMLESS, CTRUNCATE) for further data
reduction.</p>

<p>The MOSFLM program was originally written to process data
collected on film,&nbsp; largely by Alan Wonacott. It was then modified
to
process data collected
using the image plate detector developed at the EMBL outstation in
Hamburg by Jules Hendrix and Arno Lentfer. This is the current version of the program, which will
also process data from CCD and hybrid pixel detectors.</p>

<h2><a class="mozTocH2" name="mozTocId827268"></a><font face="Times New Roman, serif"><font size="4"><b>1.2
Installation</b></font></font></h2>

<p>The new GUI (iMosflm) is currently available for Windows, Mac OSX
and Linux platforms. For details of installation visit
<a href="http://www.mrc-lmb.cam.ac.uk/mosflm/imosflm">http://www.mrc-lmb.cam.ac.uk/mosflm/imosflm</a><br>
</p>

<h2><a class="mozTocH2" name="mozTocId410751"></a><font face="Times New Roman, serif"><font size="4"><b>1.3
Documentation</b></font></font></h2>

<p>There are two distinct sources of documentation for MOSFLM,
although neither of these currently makes any reference to the new
GUI. At present, this document is the only documentation available
for iMosflm. <br>
</p>

<p><span style="font-weight: bold;">Also, only this document is updated
for new features of MOSFLM since version 7.0.9 (June 2012).</span> </p>

<ol>

  <li>
    <p>The MOSFLM user guide. This is available as a plain text
file (mosflm_user_guide.txt) or on the web
(<a href="http://www.mrc-lmb.cam.ac.uk/mosflm/mosflm">http://www.mrc-lmb.cam.ac.uk/mosflm/mosflm</a>/)
as a PDF or HTML document. This
contains considerably more detail about how ipmosflm processes
diffraction images than this tutorial does. It is a very good idea to
look through this guide before starting serious data processing with
MOSFLM, although you do not need it for this tutorial. This has not
been updated since version 7.0.9 (June 2012).<br>
    </p>
  </li>
  <li>
    <p>The "on-line" help. If you type "help" at the "MOSFLM =&gt;"
prompt (after starting the program mosflm) all possible keywords are
listed, with information on each keyword. This information is stored in
an ASCII file (mosflm.hlp) which can also be read (and searched) with
an editor. This relies on having the environment variable
"CCP4_HELPDIR" set to the directory containing this file. This is also
available on the MOSFLM web pages under "keyword synopses"</p>
  </li>
</ol>

See
also: <br>

Powell, H.R., Battye, T.G.G., Kontogiannis, L., Johnson, O. &amp;
Leslie, A.G.W. 2017 Integrating macromolecular X-ray diffraction data
with the graphical user interface iMosflm. Nature protocols 12,
1310-1325. <br>

This has examples of processing "difficult" datasets that can be
downloaded from the website.<br>

<br>

Battye, T.G.G., Kontogiannis, L., Johnson, O., Powell, H.R. &amp;
Leslie, A.G.W. 2011. iMosflm: a new graphical interface for diffraction
image processing with MOSFLM. Acta Cryst. <span style="font-weight: bold;">D67</span>, 271-281.<br>

<h2><a class="mozTocH2" name="mozTocId816121"></a><font face="Times New Roman, serif"><font size="4"><b>1.4
Aims of the tutorial</b></font></font></h2>

<p>Your task is to process 84 images, hg_001.mar1600 to
hg_084.mar1600, collected on a Mar345 image plate detector at a
synchrotron beamline. These are crystals of a small domain (91 amino
acids) that have been soaked in a mercury compound, resulting in a
dataset with a strong anomalous signal which can easily be used to
solve the structure. These images have kindly been provided by
Camillo Rosano. <br>
</p>

<p>Note: You can equally well choose to process your own diffraction
images if you wish </p>

<h2><a class="mozTocH2" name="mozTocId689712"></a><font face="Times New Roman, serif"><font size="4"><b>1.5 Mouse and key
functions<br>
</b></font></font></h2>

For simplicity, the mouse and key functions are
all described here, although they will also be referred to at various
points in the tutorial.<br>

<br>

When positioned over the image, right mouse button will return the
display to the full size image if it has been zoomed. Scrolling middle
mouse will zoom/shrink the image.<br>

Holding down the "Ctrl" key (or "Alt" or "Cmd" (for Macs)) will display
the resolution and the current mouse position on the image
in mm and pixels. If positioned over a found spot (at the indexing stage), the spot coordinates
and I/σ(I) will be given. If positioned over a predicted spot position
(after indexing) the&nbsp;&nbsp; <i>hkl</i> indices will be shown.<br>

Holding down the "Shift" key while the "Zoom" icon in the image is
selected will show the image within
the small dotted square zoomed within the solid square.
<br>

<br>

<h1><a class="mozTocH1" name="mozTocId360577"></a><font face="Times New Roman, serif">2. Overview
of iMosflm</font></h1>

<p>Start the program by typing "imosflm". After a brief
pause, the following window will appear (note, the date and version
will be different):</p>

<p><img src="images/img_001_2.0_overview.png" name="graphics1" solid="" align="left" border="0" width="100%">The
basic operations listed down the left hand side (Images, Indexing,
Strategy, Cell Refinement, Integration, History) can be selected by
clicking on the appropriate icon, but those that are not appropriate
will be greyed-out and cannot be selected.</p>

<h2><a class="mozTocH2" name="mozTocId626255"></a><font face="Times New Roman, serif"><font size="4"><b>2.1
Drop Down menus</b></font></font></h2>

<p>Clicking on "Session" will result in a drop-down menu
that allows you to save the current session or reload a previously
saved session (or read/save a&nbsp;<a href="#mozTocId323598" target="_blank">site file</a><a href="#mozTocId323598" target="_blank">
</a>(see §14.1) or add images, or since 7.2.0, write a spots file):</p>

<p><img src="images/img_002_2.1_session.png" name="graphics2" align="bottom" border="0" height="324" width="534">
</p>

<p>Clicking on "Settings" will allow you to see (and
modify) Experiment settings, Processing options and Environment
variables. <br>
</p>

<p><img src="images/img_003_2.1_settings.png" name="graphics54" align="bottom" border="0" height="106" width="190">
</p>

<p>The "Experiment settings" option has two tabs, Experiment and
Detector. <br>
</p>

<p>In the Experiment tab, experimental parameters (beam position,
detector distance, beam divergence and polarisation, wavelength and
detector Two Theta angle can be modified. There is also a tick box to
deal with beamlines where the phi rotation is in the opposite sense to
the conventional one. These parameters are read from the image header,
but if they are wrong they can be corrected here.</p>

<p>The Detector tab lists the current values of the refineable detector
parameters, the detector gain, ADC offset and pixel size (in mm). There
is a "Reset" button that will reset all refineable detector parameters
to their initial values. This should be used if parameters have refined
to unreasonable values, either because they are poorly defined or
because an incorrect indexing soltuion has been used to integrate
images. A pop-up warning message will be given in such cases, and
parameters can also be reset from this pop-up window.</p>

<p>Note: If information in the image headers is incorrect, some of the
parameters can be read from a "<a href="#mozTocId323598">site file</a>"
so that they do not have to be entered manually for every iMosflm
session. If the phi
values are not correct (e.g. all values are zero) the correct values
can be set by editing the phi values for the first image (see Advanced
Usage box in the following section).<br>
</p>

<br>

<p><img style="width: 475px; height: 570px;" alt="" src="images/img_003b_2.1_reset.png"><br>
</p>

"Processing options" will open a window with six tabs: Spot finding,
Indexing, Processing, Advanced refinement, Advanced integration and
Sort Scale and Merge. This allows parameters associated with these
processing steps to be changed, and provides additional options such as
pattern matching orientation refinement (see <a href="#mozTocId775517">8.4</a>),
addition of Pilatus or Eiger images to assist in spot finding or
detector parameter refinement and smoothing of missetting
angles (see <a href="#mozTocId905962">9.6</a>). Situations in which it
may be useful to modify these parameters
will be described in the appropriate section of the tutorial. A summary
is provided in the "<a href="#mozTocId727216">Tips</a>" section.<br>

<br>

<img style="width: 676px; height: 136px;" alt="" src="images/img_003c_2.1_processing_options.png"><br>

<br>

"Environment variables"will not normally require any changes.<br>

<br>

<p>The three small icons below "Session" allow you to start
a new session, open a saved session or save the current session.
Moving the mouse over these icons will result in display of a tooltip
describing the action taken if the icon is clicked.</p>

<h1><a class="mozTocH1" name="mozTocId486119"></a><font face="Times New Roman, serif"><b>3. Adding
images to a session</b></font></h1>

<p>To add images to a session, use the "Add images..."
icon: </p>

<p><img src="images/img_004_3.0_addimage.png" name="graphics3" align="bottom" border="0" height="102" width="202">
</p>

<p>Select the correct directory from the pop-up Add Images window
(the default is the directory in which iMosflm was launched). All
files with an appropriate extension (which can be selected from the
"File type") will be
displayed. <br>
</p>

<p>Note that for images where the image number is given as the
extension (eg my_xtal.001) you will need to select "Numbered files" as
the File type.</p>

<p>For Eiger HDF5 files, select the "master" file (this will normally
be the only file listed). Nexus files (written at Diamond Light Source)
are not currently handled.<br>
</p>

<p>Double-clicking on any file will result in all images with
the same template (or all images in HDF5 files) being added to the
session. The template is the
whole part of the filename prefix, except the number field which
specifies the image number. An alternative is to single-click on one
image filename and then click on Open.</p>

<p><img src="images/img_005_3.0_imgfiles.png" name="graphics4" align="bottom" border="0" height="404" width="452">
</p>

<p>To open one or several images only, check the 'Selected images
only' box and then use click followed by Shift+click to select a
range of images or Control+click to select individual image files as
required. This is not an option with HDF5 files.<br>
</p>

<p>Loaded images will be displayed in the Images window with the
start &amp; end phi values displayed (as read from the image header) as shown below.</p>

<p><img style="width: 1082px; height: 857px;" alt="" src="images/img_006_3.0_overview.png"><br>
</p>

<p>All images with the same template belong to the same "Sector"
of data. </p>

<p>Multiple sectors can be read into the same session. Each sector
can have a different crystal orientation. </p>

<p>For the Mar images in the tutorial dataset, note that a "Warning"
has appeared. Click anywhere on
the “warnings 1” text to get a brief description of the warning.
In this case it is because the direct beam coordinates stored in the
MAR image plate images are not 'trusted' by MOSFLM and the direct
beam coordinates have been set to the physical centre of the image.
Click on the "X" on the right hand side to dismiss this
warning; click anywhere outside the warning box to collapse the box;
double-click the warning text itself to obtain more detailed information and advice on how to improve the processing.<br>
</p>

<p><img src="images/img_007_3.0_warning.png" name="graphics6" align="bottom" border="0" height="86" width="420">
</p>

<p>The direct beam coordinates (read from the image header or set by
MOSFLM) and crystal to detector distance are displayed. These values
can be edited if they are not correct.</p>

<p><img src="images/img_008_3.0_directbeam.png" name="graphics7" align="bottom" border="0" height="78" width="330">
</p>

<p><br>
<br>
</p>

<table border="2" bordercolor="#ff0000" cellpadding="2" cellspacing="2">

  <tbody>
    <tr>
      <td>
      <p><b>Advanced Usage</b> </p>
      <ol>
        <li>
          <p>The phi values of images can be edited in the Image
window. First click on the "Image&nbsp; 1" line to highlight it then
click with the mouse over the phi values to make them editable allowing
new values to be given. These new values are propagated for all
following images in the same sector, assuming a constant rotation angle
per image. Starting values for the three missetting angles (PHIX, PHIY,
PHIZ)&nbsp; may also be entered following the image phi values.</p>
        </li>
        <li>
          <p>To delete a sector click on the sector name to select it
(it turns blue) then use the right mouse button on the sector to bring
up a "delete" button. Move the mouse over the delete button (it turns
blue) and click to delete the sector and its images. Individual images
can be deleted from the Images pane in the same way.</p>
        </li>
        <li>
          <p>If
one sector is added and used for indexing, and then a second sector
from the same crystal is added, the matrix for the second sector will
not be defined. To define it, double-click on the matrix name for the
first sector, save it to a file, double-click on the matrix name
(Unknown) for the new sector and read the matrix file written for the
first sector. Alternatively, it is possible to "drag and drop" the
matrix from the first sector onto the second sector (drop onto the
sector itself, not the Matrix for the second sector).<br>
          </p>
        </li>
      </ol>
      </td>
    </tr>
  </tbody>
</table>

<h2><a class="mozTocH2" name="mozTocId215473"></a>3.1 Summing images
when reading hdf5 files (chunking)<br>
</h2>

When reading images in hdf5 format, there is an option to automatically
sum the images prior to processing. If the oscillation angle per image
is less than 0.2°, a pop-up window as shown below will appear
suggesting that processing may work best if images are summed, and
giving various options. The number of images to be summed can also be
specified in the Settings -&gt; Processing options -&gt; Processing
tab. Note that the image numbers in the iMosflm plots will then refer
to "virtual" images after summation, not the original image numbers.
Generally processing will work well with an oscillation angle of 0.1°
or greater, but this allows an option to work with summed images
instead. This will speed up the processing of the dataset. <br>

<br>

This option is only available for hdf5 files, but Pilatus cbf or Eiger
(cbf or hdf5) images can be summed for the purpose of spot finding (see
I<a href="#mozTocId495561">f the spot finding has not worked well) </a>or
determining the centroid of reflections for refinement (<big><small>see&nbsp;
§<a href="tutorial_7.3.0.html#mozTocId109529">8.2.1</a></small></big>)
but still integrated individually.<br>

<br>

<img style="width: 562px; height: 336px;" alt="Chunking dialogue" src="images/img_008b_3.1_chunkimages.png"><br>

<br>

<h1><a class="mozTocH1" name="mozTocId44996"></a><font face="Times New Roman, serif">4. Image
Display</font></h1>

<p>When images are added to a session, the image that was selected at
the "Add images" step is displayed in a separate display window.</p>

<p><img src="images/img_009_4.0_image.png" style="border: 0px solid ; width: 100%;" alt="" name="graphics8">
</p>

<p>The "Image" drop-down menu allows display of the
previous or next image in the series (but this is easier to perform
using the blue arrows displayed before the image name). <br>
</p>

<p>The "View" drop-down
menu allows the image to be displayed in different sizes (related by
scale factors of two), based on the image size and the resolution of
the monitor.</p>

<p>The "Settings" drop-down menu allows the colour of the predictions
to be changed (see&nbsp;<a href="#mozTocId286296" target="_blank">Indexing</a>
§5.2 for the default colours), and the size of the "Pick" box to be
changed. The third option (image summation) determines whether summed
images are calculated by addition or by taking the maximum or minimum
values. At present, only addition is implemented.<br>
</p>

<p>The line below allows selection of different images, either using
right and left blue arrow or selecting one from the drop-down list of
all
images in that sector. Alternatively the image number can be typed into
the "Go to" entry box. <br>
</p>

<p>For Pilatus and Eiger images only, the "Sum" entry box will allow
the display of the sum of several
images, the number (up to 20) can be chosen from the drop-down list.</p>

<p>The image being displayed can also be changed
by double-clicking on an image in the list shown in the "Images" pane of
the main iMosflm window. This will also re-active the image window if
it has been closed.<br>
</p>

<p><img src="images/img_010_4.0_histogram.png" name="graphics56" align="bottom" border="0" height="418" width="388">
</p>

<p>"+" and "-" will zoom the image without
changing the centre. The "Fit image" icon will restore the
image to its original size (right mouse button will have the same
effect). The "Contrast" icon will give a histogram of pixel
values. Use the mouse to drag the vertical dotted line, to the right
to lighten the image, to the left to darken it. Try adjusting the
contrast. The "Lattice" entry window can be used when processing images
with multiple lattices present, see&nbsp;<a href="#mozTocId189423">multiple
lattices</a> §5.3.</p>

<p>The "reverse video" icon allows an image to be rendered as light
spots on a dark background that can help visualise small diffraction
spots (e.g. for data collected using a Pilatus or Eiger detector).<br>
</p>

<h2><a class="mozTocH2" name="mozTocId114918"></a><font face="Times New Roman, serif"><font size="4"><b>4.1
Display Icons</b></font></font></h2>

<p><img style="width: 645px; height: 29px;" alt="" src="images/img_011_4.1_icons.png"></p>

<p>
The eight icons on the left, control the display of the direct
beam position (magenta cross), spots
found for indexing, bad spots, predicted reflections, masked
areas, spot-finding search area, resolution limits and display of the
active mask for Rigaku detectors respectively. Clicking on these items
will turn their display on or off.<br>
</p>

<p>These are followed by icons for Zoom, Pan and Selection tools, and
tools for adding spots manually (for indexing), defining masks, circle
fitting and erasing spots or masks (the pink eraser). The final icon
allows the phi profile of a reflection to be displayed (see <a href="#mozTocId431248">§5.6.2</a>).</p>

<p>Next on this toolbar are the entry boxes for <i>h, k</i> &amp; <i>l</i> indices for a reflection. If this reflection is present among
the predicted spots for this image, a green tick will be displayed in
the button following the entry boxes, and a large X will be drawn over
that reflection in the display. If it is not present a red exclamation
mark will be displayed (as above).The final
icon relates to processing images with multiple lattices, (see&nbsp; <a href="#mozTocId189423" target="_blank">multiple lattices</a> §5.3)
and is not described here.<br>
</p>

<h3><a class="mozTocH3" name="mozTocId74027"></a><font face="Times New Roman, serif"><font size="3"><b>4.1.1
Masked areas - circular backstop shadow</b></font></font></h3>

<img style="width: 642px; height: 28px;" alt="" src="images/img_012_4.1.1_maskareaicon.png"><br>

<br>

<em>Select
the masked area icon.</em> A green circle will be displayed showing
the default position and size of the backstop shadow.
<p><img style="width: 642px; height: 27px;" alt="" src="images/img_013_4.1.1_zoomicon.png"><br>
</p>

<p><em>Make
sure that the Zoom icon (magnifying glass) is selected and use the
left-mouse-button (abbreviated to LMB in following text) to drag out
a rectangle around the centre of the image.</em> The inner dotted
yellow rectangle will show the part of the image that will actually
appear in the zoomed area.</p>

<p><img src="images/img_014_4.1.1_backstop.png" name="graphics12" align="bottom" border="0" height="323" width="327">
</p>

<p><img style="width: 642px; height: 28px;" alt="" src="images/img_015_4.1.1_pointer.png"><br>
</p>

<p>
<em>Choose
the Selection Tool.</em> When placed over the perimeter of the
circle, the radius of the circular backstop shadow will be displayed.
<em>Use the LMB to drag the circle to increase its diameter to that
of the actual shadow on the image.</em> The position of the circle
can be adjusted with LMB placed on the cross that appears in the
centre of the green circle. <em>Adjust the size and position of the
circle so that it matches the shadow.</em></p>

<h3><a class="mozTocH3" name="mozTocId23713"></a><font face="Times New Roman, serif"><font size="3"><b>4.1.2
Masked areas - general exclusions</b></font></font></h3>

<img style="width: 642px; height: 28px;" alt="" src="images/img_016_4.1.2_maskicon.png"><br>

<em>Choose the Masking tool</em>. Any existing masked areas will
automatically be displayed. <em>Use LMB to define the four corners of
the region to be masked.</em> When the fourth position is given, the
masked region will be shaded. This region will be excluded from spot
finding and integration. This provides a powerful way of dealing with
backstop shadows (note that multiple masks can be defined). To modify
an existing mask, choose the Selection tool
and use the LMB to drag any of the four vertices to a new position.
<p>To delete a mask, choose the Spot and mask eraser tool. Place the
mouse anywhere within the shaded masked area, and use LMB to delete
the mask. <em>Delete any masks that you have created.<br>
<img style="width: 642px; height: 28px;" alt="" src="images/img_017_4.1.2_rubbericon.png"><br>
</em></p>

<h3><a class="mozTocH3" name="mozTocId209370"></a><font face="Times New Roman, serif"><font size="3"><b>4.1.3 Spot
search area</b></font></font></h3>

<p><em><img style="width: 644px; height: 28px;" alt="" src="images/img_018a_4.1.3_spotsearchicon.png"><br>
</em></p>

<p><em>Select the Show spotfinding search area icon.</em> The inner
and outer radii for the spot search will be displayed as shown below.
If the images are very weak, the spot finding radius will
automatically be reduced (this behaviour can be changed using the
Settings -&gt; Processing options -&gt; Spot finding -&gt; Automatic
Resolution reduction tickbox), but this provides additional control
over the area to be searched.</p>

<p>Either can be changed by dragging with the LMB. <em>Do not change
the radii for these images.</em></p>

<p><img src="images/img_018_4.1.3_spotsearch.png" name="graphics16" align="bottom" border="0" height="471" width="439">
</p>

<p><br>
<br>
</p>

<table border="1" bordercolor="#ff0000" cellpadding="2" cellspacing="3">

  <tbody>
    <tr>
      <td>
      <p><b>Advanced Usage</b></p>
      <p>The red rectangle displays the area used to determine an
initial estimate of the background of the image. It is important that
this does not overlap significant shadows on the image. It can be
shifted laterally or changed in orientation (in 90° steps) by dragging
with the LMB.</p>
      </td>
    </tr>
  </tbody>
</table>

<h3><a class="mozTocH3" name="mozTocId890852"></a><font face="Times New Roman, serif"><font size="3"><b>4.1.4
Resolution limits</b></font></font></h3>

<img style="width: 642px; height: 28px;" alt="" src="images/img_019_4.1.4_resolutionicon.png"><br>


<em>Select the Show resolution limits icon.</em> The circular low
and high
resolution limits will be displayed. The resolution limits can be
changed by dragging the perimeter of the circle with LMB (make sure
that the Selection Tool has been chosen). The resolution limits will
affect Strategy, Cell refinement and Integration, but not spot
finding or indexing. The low resolution is not strictly correct (it
falls within the backstop shadow) but does not need to be changed
because spots within the backstop shadow will be rejected.
<p><img src="images/img_020_4.1.4_resolutionimg.png" name="graphics55" align="bottom" border="0" height="517" width="600"></p>

<h3><a class="mozTocH3" name="mozTocId746242"></a><font face="Times New Roman, serif"><font size="3"><b>4.1.5 Zooming
and Panning</b></font></font></h3>

<em>
First
select a region of the image to be zoomed with the Zoom tool.<br>
<br>
</em><img style="width: 642px; height: 28px;" alt="" src="images/img_021_4.1.5_panicon.png"><br>

<span style="font-style: italic;">Select the Pan tool and pan the
displayed area by holding down LMB
and moving the mouse. </span><br>

<h3><a class="mozTocH3" name="mozTocId310974"></a><font face="Times New Roman, serif"><font size="3"><b>4.1.6
<span style="font-family: Times New Roman,Times,serif;">Circle fitting</span></b></font></font></h3>

<p>The circle fitting tool can be used to determine the direct beam
position by fitting a circle to a set of points on a powder
diffraction ring on the image (typically due to icing) or to fit a
circular backstop shadow (although using the masking tool is probably
easier).</p>

<p><img style="width: 641px; height: 27px;" alt="" src="images/img_022_4.1.6_circleicon.png"><br>
</p>

<p><em>Select the circle fitting tool. Three new icons will appear in
the image display area. There are two (faint) ice rings visible on
the image at 3.91Å and 3.67Å. Click with LMB on several positions
(6-8) on the outer ring (as it is slightly stronger). Then click on
the top circular icon.</em></p>

<p>A circle that best fits the selected points (displayed as yellow
crosses) will be drawn, and the direct beam position at the centre of
this circle will be indicated with a green cross. The direct beam
coordinates will be updated to reflect this new position.</p>

<p><img src="images/img_023_4.1.6_circleimg.png" style="border: 0px solid ; width: 100%;" alt="" name="graphics20">
</p>

<h3 style="font-family: Times New Roman,Times,serif;"><a class="mozTocH3" name="mozTocId822853"></a><small>4.1.7 Phi
profile</small></h3>

<img style="width: 642px; height: 27px;" alt="" src="images/img_023a_4.1.7_phiprofileicon.png"><br>

<br>

For version 7.4.0 onwards, the phi profile of individual reflections
can be plotted using the "Phi profile" icon. More details can be found
in section <a href="#mozTocId431248">5.6.2</a><br>

<h1><a class="mozTocH1" name="mozTocId150573"></a><font face="Times New Roman, serif">5. Spot
finding, indexing and mosaicity estimation</font></h1>

<p>When images have been added to the session, the "Indexing" operation
becomes accessible (it is no longer greyed-out).</p>

<p><em>Click on Indexing.</em> This will bring up the major Indexing
window in place of the Images window.</p>

<h2><a class="mozTocH2" name="mozTocId591049"></a><font face="Times New Roman, serif"><font size="4"><b>5.1
Spot Finding</b></font></font></h2>

<p>By default, the first image and a second image 90° away in phi (or
as close to 90°
as possible) will be selected and a spot search carried out on both
images (This
is controlled by the "Automatically find spots on entering
Autoindexing" tick box in the Spot finding tab of Processing options).</p>

<p>Found spots will be displayed as crosses in the Image Display window
(red for those above the intensity threshold, yellow for those below).
Only those above the threshold will be used in indexing. The intensity
threshold normally defaults to 20, but will be automatically
reduced to 10 or 5 for weak images. The threshold is determined by the
last
image to be processed.</p>

<p><img src="images/img_024_5.1_indexspots.png" name="graphics57" align="bottom" border="0" height="143" width="746">
</p>

<p><br>
<br>
</p>

<p>The number of spots found, together with any manual additions or
deletions, are also given.</p>

<p>Images to be searched for spots can be specified in several ways:</p>

<ol>

  <li>
    <p style="background: transparent url(none) repeat scroll 0% 50%; margin-bottom: 0cm; -moz-background-clip: -moz-initial; -moz-background-origin: -moz-initial; -moz-background-inline-policy: -moz-initial;">Simply
type in the numbers of the images (e.g. 1, 84 above).</p>
  </li>
  <li>
    <p style="background: transparent url(none) repeat scroll 0% 50%; margin-bottom: 0cm; -moz-background-clip: -moz-initial; -moz-background-origin: -moz-initial; -moz-background-inline-policy: -moz-initial;">Use
the "Pick first image" icon (single blue circle).</p>
  </li>
  <li>
    <p style="background: transparent url(none) repeat scroll 0% 50%; margin-bottom: 0cm; -moz-background-clip: -moz-initial; -moz-background-origin: -moz-initial; -moz-background-inline-policy: -moz-initial;">Use
the "Pick two images ~90 apart" icon (two blue circles) . This is the
default behaviour.</p>
  </li>
  <li>
    <p style="background: transparent url(none) repeat scroll 0% 50%; margin-bottom: 0cm; -moz-background-clip: -moz-initial; -moz-background-origin: -moz-initial; -moz-background-inline-policy: -moz-initial;">Use
the "Select images ..." icon (multiple circles). If selected, all
images in the sector are displayed in a drop-down list. Click on a
image to select it, then double-click on the search icon (resembling a
target, in the colum headed "Find") for that image to run the spot
search. The image will move to the top of the list (together with other
images that have been searched).</p>
  </li>
</ol>

<p>Images to be used for indexing can be selected from those that
have been searched by clicking on the "Use" button. If this
box was previously checked, then clicking will remove this image from
those to be used for indexing. It can be added again by clicking the
"Select images ..." icon and clicking on the "Use"
box.</p>

<p><span style="font-weight: bold;">Before indexing, always check by
looking at the image display that the spot finding has worked
correctly, ie that most spots that you can see have been found, that
multiple crosses have not been drawn over the same spot, that spots
have not been placed over ice rings or ice spots. Check all images that
will be used in indexing.</span><br>
</p>

<h3><a class="mozTocH3" name="mozTocId495561"></a><font face="Times New Roman, serif"><font size="3"><b>5.1.1
If the spot finding has not worked well<br>
</b></font></font></h3>

<p>It is possible to get more details on the spot finding and these can
be useful in deciding which parameters to change in the spot search.
Use LMB to select an image used in spot finding, the line will be
highlighted, then use right mouse button to bring up a "Details"
button. <br>
</p>

<p><img style="width: 709px; height: 67px;" alt="" src="images/img_024a_5.1.1_detailsbutton.png"><br>
</p>

<p><br>
Clicking with LMB on "Details" will pop up a window giving the spot
search results for this image.<br>
</p>

<p><img style="width: 749px; height: 387px;" alt="" src="images/img_024b_5.1.1_spotresults.png"><br>
</p>

<p>In this case there are a very large number of spots rejected as
having too few pixels. While many of these are probably not real spots,
it suggests that reducing the minimum number of pixels (30 in this
cases as this was data from an in-house source) might help finding more
spots.<br>
</p>

<p>Parameters affecting the spot search can be modified by selecting
the "Settings" drop-down window and selecting "Processing
options". The resulting new window contains six tabs relating
to Spot finding, Indexing, Processing, Advanced refinement, Advanced
integration and Sort, Scale and Merge.</p>

<p>The Spot finding tab allows the Search area, Spot
discrimination parameters, Spot size parameters, Minimum spot
separation and Maximum peak separation within spots (to deal with
split spots) to be reset. It also allows the choice between a local
background determination (preferred) and a radial background
determination. The local background method also uses an improved
procedure for recognising closely spaced spots. <br>
</p>

<p>In addition, for Pilatus or Eiger images (cbf or hdf5) there is an
option to sum images for spot finding that can be useful for very weak
images (heading "Number of images to sum when spot finding"). <br>
</p>

<p>The only parameters
commonly changed are:</p>

<ol>

  <li>
    <p style="margin-bottom: 0cm;">Minimum spot separation. This
should be the size (in mm) of an average spot (not a very strong spot).
If there are badly split spots, the spot finding may place two (or
more) crosses for a single diffraction spot. To avoid this
happening,&nbsp; set the minimum separation in X and Y to values equal
to the spot size in mm. This can be found by zooming the image and
counting the number of pixels across the spot horizontally (X) and
vertically (Y). To convert this to mm, use the pixel size as given in
Settings -&gt; Experiment settings -&gt; Detector. This separation
parameter is very important when spots are very close, but usually the
program will determine a suitable value. </p>
  </li>
  <li>
    <p style="margin-bottom: 0cm;">Minimum pixels per
spot. Default value 6&nbsp; for synchrotron data but should be reduced
automatically if
spots are very small (eg when using in situ screening and microfocus
beam). If there clearly are spots present and the spot size is very
small, try reducing this parameter to 3 or 2. </p>
  </li>
  <li>
    <p>Local background box size. Reducing this from 16
to (say) 10 can reduce the number of "false" spots found near any sharp
shadow on the image (or tile boundaries for tiled detectors). Normally
these "false" spots are weak (and will be drawn as yellow crosses) in
which case they will not affect the indexing. </p>
  </li>
</ol>

<p>For data collected in-house, the spots can be quite large and rather
weak. In such cases the spot finding parameters are automatically
changed, but some improvement may still be obtained by the
following: </p>

<ol>

  <li>
    <p>Reduce the spot finding threshold (default 3.5), e.g. to 2. </p>
  </li>
  <li>
    <p>Change the minimum number of pixels per spot (default 30) to 20
or even fewer for weak "fuzzy" spots, or increase to 40 or higher for
large strong spots <br>
    </p>
  </li>
  <li>
    <p>Set the minimum spot separation to a sensible value, e.g. 1.5mm,
see above.</p>
  </li>
</ol>

Note that the detector gain is a crucial parameter when finding spots.
The default value should be correct for most commercial detectors, but
if the images are collected on an unusual detector and then converted
to a format that iMosflm recognises, for example in electron diffraction
applications, the detector gain may be incorrect (see <a href="#mozTocId11307">Processing electron diffraction images)</a><br>

<h2><a class="mozTocH2" name="mozTocId325663"></a><font face="Times New Roman, serif"><font size="4"><b>5.2
Indexing</b></font></font></h2>

<p>Providing there are no errors during spot finding, indexing will
be carried out automatically after spot finding (This is controlled by
the "Automatically index after spot finding" tick box in the Indexing
tab
of Processing options). If the image
selection or indexing parameters are changed, the "Index"
button must be used to carry out the indexing. </p>

<p><img src="images/img_025_5.2_indexpane.png" name="graphics21" align="bottom" border="0" width="100%">
</p>

<p><br>
<br>
</p>

<p>Autoindexing will be carried out by MOSFLM using spots (above the
threshold) from the selected images. The threshold is set by MOSFLM
but can be changed using the entry box in the toolbar. The list of
solutions, sorted by increasing penalty score, will appear in the
lower part of the window. The preferred solution will be highlighted
in blue. There will usually be a set of solutions with low penalties
(0-20) followed by other solutions with significantly higher
penalties. The preferred solution is that with the highest symmetry
from the group with low penalty values.</p>

<blockquote>Note that <em>all</em> these solutions are really the
same P1 solution transformed to the 44 characteristic lattices, with
lattice symmetry constraints applied. Therefore, if the P1 solution
is wrong, then all the others are wrong as well. </blockquote>

<p>For solutions with a penalty less than 50, the refined cell
parameters ("ref") will be shown. This can be expanded
(click on the + sign) to show the "reg" unrefined but
regularised cell (symmetry constraints applied) and the "raw"
cell (no symmetry constraints applied).</p>

<p>The rms deviation (rmsd) or error in predicted spots positions
(σ(x,y) in mm)
and the number of spots used to refine the solution are given for each
solution.</p>

<p>Usually the penalty will be less than 20 for the correct solution,
although it could be higher if there is an error in the direct beam
coordinates (or distance/wavelength). The rmsd (error in spot
positions) will typically be 0.1-0.2mm for a correct solution, but if
the spots are split or very elongated it can be as high as 1mm or
higher.</p>

<p>The predicted spot positions for the highlighted solution will be
shown
on the image display with the following default colour codes:</p>

<dl>

  <dd>
    <table cellpadding="2" cellspacing="2">
      <tbody>
        <tr>
          <td>
          <p>Blue: </p>
          </td>
          <td>
          <p>Fully recorded reflection</p>
          </td>
        </tr>
        <tr>
          <td>
          <p>Yellow (orange for Pilatus): </p>
          </td>
          <td>
          <p>Partially recorded reflection </p>
          </td>
        </tr>
        <tr>
          <td>
          <p>Red: </p>
          </td>
          <td>
          <p>Spatially overlapped reflection... these will NOT be
integrated </p>
          </td>
        </tr>
        <tr>
          <td>
          <p>Green: </p>
          </td>
          <td>
          <p>Reflection width too large (more than 5 degrees)... not
integrated. </p>
          </td>
        </tr>
      </tbody>
    </table>
  </dd>
</dl>

<p>These colours may be adjusted via the "Settings -&gt; Prediction
colour" item in the Image display window.</p>

<p>Providing there are no errors in the indexing, MOSFLM will
automatically estimate the mosaic spread (mosaicity) based on the
preferred solution. </p>

<p style="font-style: italic;">Select other solutions with a higher
penalty and see how well the
predicted patterns match the diffraction image.</p>

<p>The rmsd and visual inspection of the predicted pattern are the
best ways of checking if a solution is correct. If the agreement is
not good, then the autoindexing has probably failed.</p>

<p><span style="font-weight: bold;">It is often worth repeating the
indexing (once), as the refined direct beam coordinates from the first
indexing may give an improved solution (lower rmsd). </span><br>
</p>

<h3><a class="mozTocH3" name="mozTocId798805"></a><font face="Times New Roman, serif"><font size="3"><b>5.2.1
If the indexing fails - Direct beam search</b></font></font></h3>

<p>The indexing is very sensitive to errors in the direct beam
coordinates. For a correct indexing solution, the error should be less
than half the minimum spot separation. Check, for example,
that the current direct beam position is behind the backstop. If
there are any ice rings, these can be used to determine the direct
beam position (see&nbsp;<a href="#mozTocId310974" target="_blank">Circle
fitting</a> §4.1.6 ). </p>

<p>If the accuracy of the direct beam coordinates (generally read
from the image header) is uncertain, the program can perform a grid
search around the input coordinates. The number and the size of the
steps can be set from the Indexing tab of the Processing options menu
(see&nbsp;<a href="#mozTocId626255">Settings - Processing options</a>
§2.1) but defaults to two steps
of 0.5mm on each side of the input coordinates. The direct beam
search is started by clicking on the "Start beam search"
button in the Indexing pane. While in progress, it can be stopped by
clicking the&nbsp; "Abort beam search" button.</p>

<table border="0" cellpadding="0" cellspacing="0" width="867">

  <col width="404"> <col width="464"> <tbody>
    <tr valign="top">
      <td width="404">
      <p><img src="images/img_026_5.2.1_beamsearch.png" name="graphics22" align="bottom" border="0" height="161" width="376"> </p>
      </td>
      <td width="464">
      <p><img src="images/img_027_5.2.1_abortbeamsearch.png" name="graphics23" align="bottom" border="0" height="167" width="304"> </p>
      </td>
    </tr>
  </tbody>
</table>

<p>The indexing will be carried out for each set of starting
coordinates (Beam x and Beam y in the table which appears) and, if a
solution is
found, the refined beam coordinates (Beam x ref, Beam y ref), the unit
cell parameters of the triclinic solution and the rmsd error in spot
coordinates and in phi will be listed. The correct solution will
generally be the one with the smallest rms error in spot positions
(σ(x,y)). To make it simpler to identify the correct solution, once the
grid search has finished the solutions will be sorted on
σ(x,y), so the correct solution will be at the top of the list. When
sorting the solutions, those which have smaller cell parameters will be
listed first, as it is possible to have a small σ(x,y) value for an
incorrect solution with a much larger unit cell. Beware of solutions at
the top of the list where the cell is clearly too small (only happens
rarely). </p>

<p><img src="images/img_028_5.2.1_resultbeamsearch.png" style="border: 0px solid ; width: 100%;" alt="" name="graphics24">
</p>

<p>Note that <b>only</b> the triclinic (P1) solution will be
listed. <br>
</p>

<p>If there is now a solution with a smaller rmsd value than before,
and especially if more than one set of starting beam coordinates has
the same refined coordinates, this is a good indication that the beam
search has worked. Note that if the initial beam coordinates were wrong
by more than ~1.5mm, the search may not work. In this case, either
select a new starting position for the direct beam, or change the
number of steps.</p>

<p>To complete the indexing, double-click on the chosen
solution, and the full indexing will carried out for these beam
coordinates, with the solutions appearing in the upper window. The
results of the direct beam search can be hidden (collapsed) by
clicking on the "Hide" button and
recovered by clicking on the "Show" button.<br>
</p>

<p><img src="images/img_029_5.2.1_resultbeamhide.png" name="graphics24" align="bottom" border="0" height="212" width="402">
</p>

<p><br>
<br>
</p>

<h3><a class="mozTocH3" name="mozTocId960714"></a><font face="Times New Roman, serif"><font size="3"><b>5.2.2
If the indexing fails - Other parameters.</b></font></font></h3>

<p>Errors in other physical parameters (wavelength, crystal to
detector distance) can also result in failure. All these parameters
should be checked.</p>

<p>Several parameters used in autoindexing can also be adjusted using
entry fields and buttons that appear in the Indexing toolbar.</p>

<p><img src="images/img_030_5.2.2_index_parameters.png" name="graphics25" align="bottom" border="0" width="100%">
</p>

<p><br>
<br>
</p>

<p>Weak images </p>

<ol>

  <li>
    <p style="margin-bottom: 0cm;">MOSFLM automatically reduces the
I/σ(I) threshold for weak images and it may also reduce the resolution
to 4Å but lower values can be tried. It is important not to include
spots that are not "real" - a small number of false spots can prevent
the indexing from working. </p>
  </li>
  <li>
    <p>Try changing parameters for spot finding (see <a href="#mozTocId495561" target="_blank">If the spot finding has not
worked well&nbsp;</a><a href="#mozTocId495561"> </a>§5.1.1)</p>
  </li>
</ol>

<p>Multiple lattices </p>

<ol>

  <li>
    <p>Try increasing the I/σ(I) threshold (default 20), for example to
40 or 60, so that only spots from the stronger lattice are selected.
This can be done by entering a new value in the leftmost of the circled
icons above (and also via the Indexing tab of Processing options).<br>
    </p>
  </li>
</ol>

<p>All cases </p>

<ol>

  <li>
    <p style="margin-bottom: 0cm;">Include more images in the indexing.
Select images that are widely spaced in phi, not close together.<br>
    </p>
  </li>
  <li>Select images that show the clearest lunes and/or have the best
spot shape.</li>
  <li>In case the crystal orientation has changed, or if you are unsure
of the direction of positive rotation in phi, try indexing using only
one image.</li>
  <li>Make sure that the "Max cell edge" value is not too small. If in
doubt, set to 200 Å (or more if the cell is expected to be large).<br>
  </li>
  <li> If the cell parameters are known, reduce the maximum allowed
cell
edge to the known maximum cell edge. This can sometimes help filter
incorrect solutions, but use with caution as often this needs to be
~twice the largest cell for successful indexing. Alternatively, try the
"known cell" option <br>
  </li>
  <li> If the detector distance is uncertain, and the images are high
resolution (e.g. 2Å), allow the detector distance to refine during cell
refinement. Use with caution.</li>
</ol>

<br>

<h2><a class="mozTocH2" name="mozTocId189423"></a><big><font><font><b><font face="Times New Roman, serif"><font size="3"><big><b>5.3 Indexing
multiple lattices simultaneously</b></big></font></font></b></font></font></big></h2>

<br>

This is a new feature and is still undergoing development. It is most
likely to succeed when the different lattices are clearly separated, at
least at higher resolution. If the images shows badly split spots with
several components (each arising from a sub-crystal with a slightly
different orientation) then indexing may well still be impossible.<br>

<br>

After spot finding, examine the image to ensure that spots that are
close to each other but belong to different lattices have been
identified as separate spots, and not treated as a single split spot
(in which case the red cross will lie midway between the two spots).
Adjusting the minimum spot separation (Settings -&gt; Processing
options -&gt; Spot finding) can help in resolving close spots. It may
also help to increase the inner radius of the spot search region
(see&nbsp;<a href="#mozTocId209370" target="_blank">Spot search area</a><a href="#mozTocId209370" target="_blank">
</a>§4.1.3) so that low resolution reflections where the spots are not
really separated are excluded from the search.<br>

<br>

The following procedure usually provides the best chance of success:<br>

<br>

1. Select appropriate images for use in indexing. The separation of the
lattices can be clearer on some images than others. Ideally choose
several images widely separated in phi.<br>

<br>

2. Do a normal (single lattice) indexing first. This will usually work,
but will give a high positional rmsd because of the presence of more
than one lattice. This step is important because it will result in more
accurate direct beam coordinates, which are crucial for multi-lattice
indexing.<br>

<br>

3. Select the “Index multiple lattices” icon (next to the "Index"
button), the "Index" button will change to "Index multiple". <br>

<br>

<img src="images/img_031_5.3_multilattice_index.png" style="width: 100%;" alt=""><br>

<br>

<br>

The indexing results for different lattices will be
presented in different tabs, while the selected solution for each
lattice will be shown in the lower "Summary" window. Currently a
maximum of 5 lattices can be handled. The figure below shows a case
where 3 different lattices were found.<br>

<br>

<br>

<img src="images/img_032_5.3_multi_lattice_results.png" style="width: 100%;" alt=""><br>

<br>

4. Judge the success of indexing by examining the lattice type and the
cell parameters obtained for the different lattices (the cells should
be very similar) and checking that the predictions match the observed
spots. The rmsd values for correct lattices should also be
significantly smaller than the value obtained in the initial (single
lattice) indexing. It may be necessary to manually select a different
autoindexing solution for some lattices in order to get the same
lattice type (eg oP) for the different lattices. <br>

<br>

The "Split" column in the lower pane indicates the angle between the
reference lattice (with value "-") and the other lattices. This is only
calculated when the lattices have the same lattice type. In this case,
the angles between lattice 1 and lattices 2 &amp; 3 are 3.4° and 1.6°.<br>

<br>

If a lattice is clearly incorrect, it can be deleted by highlighting
that lattice (in the lower pane that summarises the results) and using
the right mouse button to select “delete”.<br>

<br>

The predictions for different lattices can be displayed either by
highlighting the lattice in the Summary window or by using the lattice
selector in the image display pane.<br>

<br>

<img src="images/img_033_5.3_lattice_selector.png" style="width: 711px; height: 534px;" alt=""><br>

<br>

In the image display, spots in different lattices that overlap with
each other are shown in magenta. Only the summed intensity will be
measured for these reflections.<br>

<br>

The predictions for all lattices
can be shown by selecting the “merge lattices” icon in the image
display.<br>

<br>

<img src="images/img_034_5.3_multilattice_display_all_icon.png" style="width: 100%;" alt=""><br>

This can be useful to check if all the lattices have been
successfully indexed, because all spots in the image should then be
predicted. In the display, predictions from lattice 1,2,3,4,5 are shown
in blue, yellow, red, green and magenta with no distinction made
between fully
and partially recorded reflections or spatial overlaps.<br>

<br>

<br>

<img src="images/img_035_5.3_display_all_lattices.png" style="width: 744px; height: 588px;" alt=""><br>

<br>

<h3><a class="mozTocH3" name="mozTocId774580"></a><small>5.3.1
Practical Tips</small></h3>

Beware of solutions where the lattices only vary in orientation by a
small angle (less than 1°) as these are often different solutions
for the same lattice. The difference in orientation between lattices is
given by the “split” column in the Summary window, but this is only
calculated if the lattices have the same lattice type. Differences are
all relative to one lattice, which will display a split angle as “-“.
To calculate the angles relative to a different lattice, open the tab
for that lattice, select a different solution to that currently
selected and then select the original solution – this will trigger
recalculation of the split angles relative to that lattice.<br>

<br>

Other parameters that can influence the indexing are the ”Maximum
deviation from integral hkl”&nbsp; (default 0.2 when indexing multiple
lattices, otherwise 0.3) and “Number of vectors to find for indexing”
(default 30). These can be changed via the Indexing tab of the
“Processing Options” that can be selected from the “Settings” menu
item. Values between 0.15 and 0.25 might be helpful for the first
parameter and increasing the number of vectors from 30 to 50 can also
help. At present there is no defined protocol for changing the default
parameter values for particular cases, it has to be done by trial and
error.<br>

<br>

Experience so far has shown that selecting appropriate images and
adjusting the maximum cell length used in indexing have the biggest
effect. The optimum value for the maximum cell length will normally lie
between one and three times the largest cell dimension, but it is worth
varying this in steps of between 25 and 50 Å, as the indexing can be
very sensitive to this parameter.<br>

<br>

<span style="font-weight: bold;">For a more complete discussion of
multiple lattice indexing see: Powell, H.R., Johnson, O. &amp; Leslie,
A.G.W. 2013. Autoindexing diffraction images with iMosflm. Acta Cryst.
D69, 1195-1203.<br>
<br>
</span><span style="font-weight: bold;"></span>
<h2><a class="mozTocH3" name="mozTocId863376"></a><small>5.4</small> <small>Known
cell option</small></h2>

For images that are very difficult to index, if the cell parameters are
known the "known cell" option can be used.<br>

Select the “Known cell” icon (next to the "Multiple lattices" icon).
Enter the cell parameters in the "Input known cell" pop-up window, and
select "OK" when all 6 parameters have been provided. Then select the
"Index Cell" button. <br>

<br>

To revert to normal indexing, select the “Known cell” icon and then
select "Clear" in the "Input known cell" pop-up window.<br>

<br>

<h2><a class="mozTocH2" name="mozTocId368904"></a><big><font face="Times New Roman, serif"><font size="3"><big><b>5.5
Space group selection</b></big></font></font></big></h2>

<p>Note that the indexing is based solely on information about the
unit cell parameters. It will therefore be very difficult (or
impossible) to determine the correct Laue group in the presence of
pseudosymmetry. For example, a monoclinic space group with β ~ 90°
will appear to be orthorhombic; an orthorhombic space group with very
similar <span style="font-style: italic;">a</span> and <span style="font-style: italic;">b</span> cell parameters will appear to be
tetragonal. These
can only be distinguished when intensities are available (i.e. after
integration) by running POINTLESS (QuickSymm) (see<font><font face="Times New Roman, serif"> <a href="#mozTocId868502">Running
Pointless to check the symmetry</a></font></font> §10).</p>

<p>In addition, it is not possible to distinguish between Laue Groups
4/m and 4/mmm, 3 and 3/m, 6/m and 6/mmm, m3 and m3m. This will not
affect integration of the images, but it will affect the strategy
calculation. <b>In the absence of additional information, the lower
symmetry should be chosen for the strategy calculation to ensure that a
complete dataset is
collected.</b></p>

<p>The presence of screw axes also cannot be detected, so there is no
basis on which to distinguish P2<sub>1</sub> from P2 etc. This does
not affect any aspect of data collection or processing, and can be
chosen (on the basis of systematic absences) after integration by
running POINTLESS.</p>

<p><em>In this example, there is no way of knowing at this stage if
the space group is h3 or h32, so leave it as h3.</em></p>

<h2><a class="mozTocH2" name="mozTocId878705"></a><font face="Times New Roman, serif"><font size="4"><b>5.6
Mosaicity estimation</b></font></font></h2>

<table cellpadding="2" cellspacing="2">

  <tbody>
    <tr>
      <td valign="top">
      <p><img src="images/img_036_5.6_mosest.png" style="border: 0px solid ; width: 403px; height: 464px;" alt="" name="graphics26"> </p>
      </td>
      <td><br>
      </td>
      <td valign="top">
      <p>If the "Automatically index after spot
finding" option has been chosen (Indexing tab of Processing Options)
the mosaicity (mosaic spread) will be estimated automatically for the
preferred solution. However, if another solution is chosen, the
mosaicity should be estimated again. </p>
      <p><em>Click on the "Estimate" button to estimate the mosaicity.</em></p>
      <p>A window will appear which plots the total predicted intensity
as a function of mosaic spread, from which an estimate is determined.</p>
      <p>The predictions displayed on the image will be updated.
Entering different values of mosaic spread in the box (followed by
return) will allow a visual estimate of the effect of changing the
mosaic spread.</p>
      <p>The mosaic spread can also be entered in the Images pane by
clicking once on the Mosaicity line and once again on the value
displayed.</p>
      </td>
    </tr>
  </tbody>
</table>

<h3><a class="mozTocH3" name="mozTocId5079"></a><big><font face="Times New Roman, serif"><font size="3"><big><b>5.6.1
The mosaic block size</b></big></font></font></big></h3>

<p>In some cases, the apparent mosaic spread is larger at low
resolution than at high resolution, so that if it is set to a value
that results in all the low resolution spots being predicted, many
more spots are predicted than are visible at high resolution. This
effect is best dealt with by adjusting the "Mosaic block size"
which is also displayed in the Images pane. This is modelling the
size, in microns, of the individual mosaic blocks in the crystal.
Decreasing this to values of 0.5-5 microns (say) from the default of
100 microns will result in predicting more spots at low resolution
but have virtually no effect at high resolution. This parameter is not
refined (at present) and so the best value must be determined by trial
and error.</p>

<h3><a class="mozTocH3" name="mozTocId431248"></a>5.6.2 The phi profile</h3>

<img style="width: 411px; height: 516px;" alt="" src="images/img_036a_5.6.2_phi_profile.png"><br>

<br>

The phi profile can be used to compare the predicted and actual
reflection widths for individual reflections. Select the "Phi profile" <a href="#mozTocId822853">icon </a>in the image display window and then
click on any predicted reflection. The reflection width is calculated
and the images on which the reflection lies are integrated and the plot
of intensity vs image number is displayed as shown above. The
"Predicted" plot is derived from the calculated fraction of the total
intensity on each image, using&nbsp; a&nbsp; model for the rocking
curve, and is scaled to the maximum experimental intensity on any
image. A good fit between the experimental intensity and the Predicted
plot suggests that the mosaic value is correct. The effect of changing
the mosaic spread can be seen by entering a new value in the entry box
and then selecting "Repeat phi profile".<br>

<br>

Note that during the integration the detector and crystal parameters
are not refined, and therefore it is important that the prediction fits
the observed diffraction well for the reflection being investigated.<br>

<br>

If the mosaic spread is high and the image width is small (eg 0.1°) the
integration can take some time. This can be reduced by selecting the
"Restrict resolution ..." check box, and in this case only reflections
in a very narrow resolution range around that of the reflection itself
will be integrated. The disadvantage of this option is that the
integration will probably need to be repeated for every new reflection
chosen.
An alternative is to select the "Extend integration..." option. If the
number 5 (say) is entered, this will increase the number of images
being integrated by a total of 10 images. The integration will start 5
images before the first image on which the current reflection occurs
and continue to 5 images after the last image on which it occurs. When
another reflection is selected, if it is predicted to start and end
within this extended integration range the integration will not be
repeated. A suitable value here might be the number of images
corresponding to 1° rotation.<br>

<br>

This option is useful in cases where the mosaic spread refinement is
unstable or results in a value very close to zero. This can happen when
the crystal is split, so that the phi profile is not unimodal (ie has
more than a single peak).<br>

<br>

It has been observed that the predicted reflection widths for
reflections lying very close to the rotation axis (especially those
flagged as "too wide in phi", green boxes) is significantly larger than
the experimentally observed reflection width. This is currently being
investigated.<br>

<h1><a class="mozTocH1" name="mozTocId958696"></a>6. Saving and
recovering a session</h1>

<p>The session can be saved at any time, using the Session drop-down
menu referred to in §2.1. The first time that a session is saved, you
will be prompted for a filename. The filename convention for saved
session files is that the extension is ".mos".</p>

<p><em>Save the current session. Then exit from iMosflm (using the
Session drop-down menu), restart iMosflm and read in the saved
session.</em></p>

<p>If the program crashes, it should be possible to recover all but
the latest actions, as a temporary copy of the session file is
continually saved to the directory ".mosflm"
in the user's home directory.<br>
</p>

<p>Restart iMosflm and it will pop up a "Recover
session ..." window.</p>

<p>Selecting the Recover button will restore the session as far as
possible. <br>
</p>

<p><img src="images/img_037_6_recoversession.png" style="width: 349px; height: 237px;" alt=""><br>
</p>

<p><br>
</p>

<h1><a class="mozTocH1" name="mozTocId38147"></a><font face="Times New Roman, serif">7. Data
collection strategy</font></h1>

<p>Once the crystal orientation and (probable) Laue group have been
determined, it is possible to calculate a data collection strategy
and the Strategy icon is no longer greyed-out (in fact, all other
operations, Strategy, Cell Refinement and Integration become possible
at this point).</p>

<p><em>Select the Strategy icon.</em> This will open the Strategy
window.</p>

<p><img src="images/img_038_7_strategy_pane.png" style="width: 100%;" alt=""><br>
</p>

<p>The statistics initially presented in the window are based on the
images read in to the current session. If only two (or more) references
images have been read in, no statistics will be presented. <br>
</p>

<p>When the Strategy option is used after two initial
images (typically 90° apart in φ) have been collected, a complete,
shaded,
segment will not be shown in the lower part of the screen, rather an
empty circle will be shown with the matrix label beneath it. Click the
'Auto-complete' button
and, in the pop-up menu that appears, select a rotation angle or
"sweep" of data to
collect - or leave the "Rotation:" setting as "Auto" for a calculation
of maximum completeness for this crystal orientation.
Click on Ok and the completeness results will be presented.</p>

<p>The orientation of the crystal, expressed as the angles between
the a,b,c unit cell axes and the X,Y,Z coordinate frame, is given. X
is along the X-ray beam, Z is the rotation axis. A warning will be
given if the unique axis is so close to the rotation axis that there
will be missing cusp data.</p>

<h2><a class="mozTocH2" name="mozTocId646178"></a><font face="Times New Roman, serif"><font size="4"><b>7.1
Evaluating completeness manually</b></font></font></h2>

<p>The completeness of any given segment of data can be determined
manually using the circle at the bottom left of the window. <em>Click
on the red segment shown in this circle.</em></p>

<p><em><img src="images/img_039_7.1_sector.png" style="width: 314px; height: 265px;" alt=""><br>
</em></p>

<p>This will result in small black boxes being drawn on the
circumference at the start and end of the red sector.</p>

<p><em>Use the LMB to click on the black box at "0", and
drag this around the circle.</em></p>

<p>When the LMB is released, the statistics for that sector will be
displayed. The statistics are presented in two ways. Near the top
right of the window, the overall completeness is shown as red circles
for unique data and anomalous pairs. The average multiplicity is
given beneath these circles.</p>

<p><img src="images/img_040_7.1_unique_anom_circles.png" style="width: 204px; height: 162px;" alt=""><br>
</p>

<p>More detailed statistics (such as completeness as a function of
resolution) are given in a series of histograms that can be selected
by a drop-down menu.</p>

<p><img src="images/img_041_7.1_histogram.png" style="width: 451px; height: 280px;" alt=""><br>
</p>

<h2><a class="mozTocH2" name="mozTocId581133"></a><font face="Times New Roman, serif"><font size="4"><b>7.2
Calculating a strategy automatically</b></font></font></h2>

<p><em><b>Uncheck</b> the 'Use' checkbox at the right side of the
hg_001 line listed
in the sector list near the top of the Strategy pane. This means that
the 84 images
used thus far will not be included in the completeness calculation;
only the matrix
derived from indexing them will be used. Select the Auto-complete
button to calculate
a strategy automatically.</em></p>

<p>A strategy calculation data pop-up window will appear:</p>

<p><img src="images/img_042_7.2_auto-complete.png" style="width: 249px; height: 159px;" alt=""><br>
</p>

<p>If multiple matrices have been defined (for different sectors of
data) then the appropriate one can be selected (if there is only one
sector, this has no effect).</p>

<p>The total φ rotation to be used is normally calculated by MOSFLM
based on the Laue group and the crystal orientation (the Auto
setting). However, it is sometimes possible to achieve a high
completeness with a significantly smaller total rotation (e.g. 60°
in two 30° segments will typically give &gt;94% completeness for
orthorhombic space groups) and this can sometimes be useful if
radiation damage
is a serious problem, although when using hybrid pixel detectors it is
better to use a very conservative exposure time and collect a wide φ
rotation . </p>

<p>Total rotation angles of between 5° and 90° can be selected from
the drop-down list. The number of segments to be used can be set
between 1 and 3.</p>

<p>If the check box is checked, data completeness will be calculated
to optimize the proportion of anomalous data collected.</p>

<p><b>THIS IS IMPORTANT. The optimum strategy is often different when
maximising completeness of the anomalous data.</b> </p>

<p><em>Choose the default values (Rotation: Auto, Segments: 1) but
check the anomalous data box, then click on "Ok". Look at
the various statistics presented as bar charts.</em></p>

<p>In space group H3, if rotating around the c axis, a total rotation
of 120° would be required to collect a complete dataset (ignoring
any data lost in the cusp). Because the c axis is 22° away from the
rotation axis in this case, it is possible to collect very high
completeness (for unique data) with a rotation much smaller than
this.</p>

<p><em>Try to find the minimum total rotation that will give a
dataset that is &gt;95% complete for the unique data. Now do the
same, but requiring &gt;95% completeness for the anomalous data.</em></p>

<p style="margin-bottom: 0cm;"><b><em>***&nbsp; SKIP OVER SECTION 7.3
IF DOING THE NORMAL TUTORIAL ***<br>
</em></b></p>

<h2><a class="mozTocH2" name="mozTocId750492"></a><font face="Times New Roman, serif"><font size="4"><b>7.3
Calculating a strategy using multiple crystals</b></font></font></h2>

<p>The Strategy pane may also be used when, due to radiation damage,
many crystals are required to collect a complete dataset .</p>

<p><span style="font-weight: bold;">IMPORTANT: This procedure will only
work correctly for space groups where there is no indexing ambiguity.
For those space groups where there is an indexing ambiguity( </span>see
<a href="http://www.ccp4.ac.uk/dist/html/reindexing.html">http://www.ccp4.ac.uk/dist/html/reindexing.html
</a>for a complete list<span style="font-weight: bold;">) it
is necessary to integrate images to determine whether different
crystals have been indexed in the same way. This is not achievable
within the Strategy option at present.</span><br>
</p>

<p>Suppose the first crystal has been indexed from the reference
images.<br>
</p>

<ul>

  <li>
    <p>Enter the Strategy pane, an empty circle is displayed in the
bottom part of the screen, and click on the 'Auto-complete' button near
the top-right of the pane. In the Auto-complete... window that appears
choose a suitable 'Rotation:' angle for the amount of data that can be
collected from one crystal, say 20 degrees for this example. Leave
'Segments:' set to 1 and do not check 'Optimize for anomalous data'.</p>
  </li>
  <li>
    <p>Click the Ok button and the completeness of the data will be
displayed. The matrix name, start and end phi values and the phi extent
will be displayed in the top area of the pane with a checkbox ticked
under the 'Use' column. This means this segment will be used in further
strategy calculations.</p>
  </li>
  <li>
    <p>Accept and save this result by clicking on the yellow, hatched
segment displayed in the large circle near the bottom of the pane.
Click once, and the segment will be outlined in black (you can adjust
the start or end phi value calculated in one degree increments by
click+dragging the respective black square), click again, this time on
the black square denoting the start or end phi (or release if you have
adjusted by click+dragging) and the segment will turn red. <i>The
segment will not be saved unless it has turned red !</i></p>
  </li>
  <li>
    <p>This result will be saved if you leave this pane (e.g. to load
more images) and return later in this session. The strategy file can
also be saved to a permanent file using the 'Save' button on the
tool-bar. <i>This is highly recommended when working with many
crystals.</i></p>
  </li>
</ul>

<p><br>
Return to the Strategy pane when you have loaded and indexed
the reference image(s) from the second crystal and repeat the
procedure above. You will see the calculated segment from the first
matrix displayed at the bottom-left of the screen. The optimum phi
range for the second crystal will be displayed. Save this in the same
way as for the first crystal (clicking twice). Repeat this procedure
for any subsequent crystals, and in each case the optimum phi range
will be calculated for the latest crystal taking into account the
data from previous crystals.</p>

<p><i>It is a good idea to save the strategy to a file as each new
crystal is added, in case the program crashes and this information is
lost.</i></p>

<p>In practice, it is probably safest to have a separate iMosflm
session that is reserved for the strategy calculations, and not used
to process any data. The strategy for each new crystal can be
calculated as described above. If there is a problem and the session
is corrupted, or if iMosflm is closed down for any reason, it is
straightforward to restore the status of the session providing the
strategy has been saved. The following steps should be taken:</p>

<p>1. Read in the reference images for the latest crystal and index
them.</p>

<p>2. Select the Strategy pane.</p>

<p>3. Read in the optimised strategy for all previous crystals using
the “Add” button and giving the appropriate filename.</p>

<p>4. Making sure that the circle for the latest crystal is
highlighted in the lower left window, click on ‘Auto-complete’
and follow the steps described above.</p>

<p><u>Advanced Usage</u></p>

<p>The start/end phi values for each crystal/matrix can be updated.
This might be required if, for example, only 10 degrees of useful
data were collected from a particular crystal instead of the
anticipated 20 degrees. To change the phi values, click either on the
matrix name in the top pane or on the circle showing the segment of
data in the lower left pane (these are highlighted in a blue box as
the mouse moves over them). The corresponding segment will now be
displayed in the larger circle. Click on the red segment so that a
black square appears at the start/end phi values. Then simply drag
the appropriate phi to the desired value. The completeness will
automatically be updated (but the strategy calculation for the latest
crystal will not be repeated, to do this the current segment must be
deleted by highlighting the matrix name and using right click and
then repeating the Auto-complete step).</p>

<p>If matrix files, saved from iMosflm, are available from crystals
for which data have been collected in previous sessions, these can be
added into the calculation using the 'Add matrix' button on the
tool-bar.</p>

<p>If the saved strategy result has become complicated or is
incorrect and you wish to restart the calculations afresh, there is a
tool-bar button, 'Reload sectors from session'. This will remove any
calculated sectors while leaving any known matrices listed at the
bottom-left of the Strategy pane.</p>

<p>If you have saved a strategy file from a previous session, this
can be used to re-initialize the Strategy pane using the 'Load'
button on the tool-bar. </p>

<p>A 'Spacegroup:' pull-down menu has been added to the tool-bar to
permit different choices of space group to be used in the
calculations (e.g. H3 and H32). This menu is populated from the list
offered on the Indexing pane. However, the space group symbol text is
editable. Any space group symbol entered will be validated by Mosflm
together with the current cell parameters<i>.</i></p>

<p>As a calculator for a multi-segment strategy, the Strategy pane is
reasonably flexible; you can Save or Delete highlighted matrix lines
by right-clicking. As you highlight different matrix lines the
orientation of the crystal, expressed as the angles between the a,b,c
unit cell axes and the X,Y,Z coordinate frame, is re-displayed in the
centre of the pane.</p>

<p>The following screen shot shows the cumulative results in the
Strategy pane after this procedure has been followed for four
crystals (ignore the iMosflm version number).</p>

<br>

<p><img src="images/img_043_7.3_multixtalstrategy.png" style="width: 100%;" alt=""></p>

<h3><a class="mozTocH3" name="mozTocId126775"></a>7.3.1 Calculating a
strategy when some data have already been collected and processed</h3>

<span style="font-weight: bold;">***&nbsp; This option is not yet
implemented ***</span><br>

If data have already been processed (to give an MTZ file) but the
images are not currently available (eg they were collected on a
previous synchrotron trip, possibly at a different synchrotron), then
the MTZ file containing this data can be read and used to calculate a
strategy for data collection from new crystals.<br>

The MTZ icon in the tool bar is used to read the MTZ file.<span style="font-weight: bold;"> </span><br>

<br>

<h2><a class="mozTocH2" name="mozTocId992584"></a><font face="Times New Roman, serif"><font size="4"><b>7.4
Calculating a suitable oscillation angle</b></font></font></h2>

<p>To calculate the maximum possible oscillation angle while avoiding
spatial overlaps, click on the "Check for overlaps" button.
A pop-up window will appear, from which the option to calculate the
maximum oscillation angle (as a function of φ) or check how many
overlaps will occur for different (user selected) oscillation angles.
The results are plotted in the same pane as the histograms for the
strategy calculations. Note that the overlap calculation is based on
the current values for the mosaic spread and spot separation, and can
be very sensitive to these values. Note also that these are <span style="font-weight: bold;">maximum</span> and not necessarily
recommended oscillation angles.<br>
</p>

<p><img src="images/img_044_7.4_overlaps.png" style="width: 363px; height: 222px;" alt=""><br>
</p>

<h1><a class="mozTocH1" name="mozTocId610524"></a><font face="Times New Roman, serif">8. Cell
refinement</font></h1>

<p>It is important to determine the cell parameters accurately before
integrating the images. Although the unit cell is refined as part of
the autoindexing, providing the diffraction extends beyond ~3.5Å
resolution, it is possible to obtain more accurate cell parameters
using a procedure known as post-refinement. This procedure requires
the integration of a series of images in ideally two or more separate
segments at widely different φ values. The distribution of the
intensity of partially recorded reflections over the images on which
they occur is used to refine the unit cell, crystal orientation and
mosaic spread.</p>

<p><em>Select the "Cell Refinement" icon</em></p>

<p><em><img src="images/img_045_8_cell_refine_pane.png" style="width: 100%;" alt=""><br>
</em></p>

<h2><a class="mozTocH2" name="mozTocId853572"></a><font face="Times New Roman, serif"><font size="4"><b>8.1
Selecting the images</b></font></font></h2>

<p>There are several ways to select the images to be used in cell
refinement. Whichever method is used, the image numbers will be
displayed in the Images entry field. iMosflm will automatically select
appropriate images, but these can be changed.<br>
</p>

<p><img src="images/img_046_8_refinement_images.png" style="width: 303px; height: 93px;" alt=""><br>
</p>

<h3><a class="mozTocH3" name="mozTocId721787"></a><font face="Times New Roman, serif"><font size="3"><b>8.1.1
Manual selection</b></font></font></h3>

<p>A list of images can simply be typed into this box. An image
series can be specified as n-m where n and m are the first and last
images. Different series must be separated by white space or comma.</p>

<p>For orthorhombic or higher symmetries, two segments should be
given, approximately 90° apart in φ. For monoclinic or triclinic
data three or four segments are best (e.g. φ = 0,45,90,135).</p>

<p>The number of images that should be included in each segment
depends on the mosaic spread and oscillation angle. A reasonable
number is 2*(mosaic spread/oscillation angle +1). MOSFLM will
automatically select two or more segments as appropriate. Note that
there is a limit on the total number of images that can be used.<br>
</p>

<h3><a class="mozTocH3" name="mozTocId716779"></a><font face="Times New Roman, serif"><font size="3"><b>8.1.2
Automatic selection</b></font></font></h3>

<img src="images/img_047_8.1.2_auto_selection.png" style="width: 372px; height: 95px;" alt=""><br>

<br>

<p>Selecting the "Automatically select images" icon will
select a suitable set of images.</p>

<h3><a class="mozTocH3" name="mozTocId766179"></a><font face="Times New Roman, serif"><font size="3"><b>8.1.3
Graphical selection (Not recommended)</b></font></font></h3>

<img src="images/img_048_8.1.3_graphical_selection.png" style="width: 372px; height: 95px;" alt=""><br>

<br>

<p>Selecting this icon will give a new window:</p>

<img src="images/img_049_8.1.3_graph_box.png" style="width: 722px; height: 314px;" alt=""><br>

<p>Images can be selected by clicking in the "Use" check-box
in the list of images, or by using the mouse to drag a selection of
images from the sector displayed. The other icons allow the sector to
be zoomed in or out and the viewed area to be moved to make the
selection easier. The final two icons on the tool-bar switch the
segment display to fit the display space as either a full circle or a
quadrant. This Image 'palette' can be closed by clicking outside its
area
but will close after 60 seconds anyway.</p>

<h2><a class="mozTocH2" name="mozTocId639269"></a><font face="Times New Roman, serif"><font size="3"><b>8.2
Integrating the images and refining the cell</b></font></font></h2>

<p><em>Use one of the methods above to select images to use in cell
refinement and click on the Process button. Before starting cell
refinement, check that the prediction for the first image <span style="font-weight: bold;">in each segment</span> to be used
is good. </em><em><b>The majority of the spot positions must be
correctly predicted for the first image in each segment, or else the
refinement will not work. If the prediction is not very good for the
second or subsequent segment, use the <a href="#mozTocId775517">Pattern
Matching option</a>.<br>
</b></em></p>

<p>The selected images will be integrated, and following integration
the cell parameters are refined. Selectable refined detector
parameters will be plotted, as will the changes in crystal
orientation and (if selected) mosaic spread. If the shift in cell
parameters is greater than 2.5 standard deviations, another cycle of
integration and cell refinement is carried out. Typically, two or
three cycles are required for convergence. Note that the current
program activity is shown in the bottom left-hand corner of the
window in the status message area.</p>

<p><img src="images/img_050_8.2_refine_results.png" style="width: 100%;" alt=""><br>
</p>

<p><br>
</p>

<p>The different windows are explained below. Moving the mouse over
any parameter or plotted graph point will give a full description of it.</p>

<h3><a class="mozTocH3" name="mozTocId109529"></a><font face="Times New Roman, serif"><font size="3"><b>8.2.1
The detector parameters window</b></font></font></h3>

<table cellpadding="2" cellspacing="2">

  <tbody>
    <tr>
      <td valign="top">
      <p>The values of the refined detector parameters are displayed
for each image as it is integrated. There is the option to fix any of
the parameters during integration by checking the "Fix" box on the
right. The positional residuals (overall, central and weighted) are
also listed.</p>
      <p>Any of these parameters can be selected for plotting on the
graph that appears to the right of this box by simply clicking on that
parameter (which is then highlighted in blue, as shown here for Beam x
and Beam y).</p>
      <p><em>Check the stability of the refined parameters by
displaying the appropriate graphs. To get sensible scaling of the
graphs, only parameters with similar numerical values should be plotted
together.</em></p>
      <p><span style="font-weight: bold;">For weak images (ie few
visible spots in the outer regions of the image) the tilt and
twist may not be well defined, and might refine to large values
(greater than one degree). In such cases these parameters should be
fixed. It is not generally recommended to fix any other detector
parameters.</span></p>
      <p><span style="font-weight: bold;"></span>For very weak fine
sliced images (Pilatus and Eiger only) there is the option to sum
images when
finding suitable spots for refinement, see Settings -&gt; Processing
Options -&gt; Advanced refinement. This can in some cases make the
refinement more stable.<br>
      <em></em></p>
      <span style="font-style: italic;"></span> </td>
      <td><br>
      </td>
      <td valign="top">
      <p><img src="images/img_051_8.2.1_detector_params.png" style="width: 294px; height: 254px;" alt=""> </p>
      </td>
    </tr>
  </tbody>
</table>

<h3><a class="mozTocH3" name="mozTocId251279"></a><font face="Times New Roman, serif"><font size="3"><b>8.2.2
The crystal parameters window</b></font></font></h3>

<table cellpadding="2" cellspacing="2">

  <tbody>
    <tr>
      <td valign="top">
      <p>The values of the refined crystal missetting angles φ(x),
φ(y), φ(z), the unit cell parameters and mosaic spread for the current
image are displayed in the table. Selected parameters will be plotted
as for the detector parameters. Specific unit cell parameters can also
be fixed.</p>
      <p>If more than one segment of data is being used for cell
refinement, it is not unusual to see a change in orientation of the
crystal between the two segments.</p>
      <p><em>Observe how the crystal orientation is different for
images in the two segments. See how the mosaic spread varies during
refinement.</em></p>
      </td>
      <td><br>
      </td>
      <td valign="top">
      <p><img src="images/img_052_8.2.2_crystal_params.png" style="width: 295px; height: 277px;" alt=""> </p>
      </td>
    </tr>
  </tbody>
</table>

<h3><a class="mozTocH3" name="mozTocId957382"></a><font face="Times New Roman, serif"><font size="3"><b>8.2.3
The central spot profile</b></font></font></h3>

<table cellpadding="2" cellspacing="2">

  <tbody>
    <tr>
      <td valign="top">
      <p>The average spot profile for the central region of the
detector is plotted for each image. This confirms that the spot
prediction is good. If the profile is not well defined and central in
the box, or if the blue border for the peak region of the spot is much
larger than the apparent spots size, it suggests a problem with the
integration and the initial prediction should be checked. In some cases
it may be necessary to increase or decrease the "Profile Tolerance"
parameters to ensure that the blue box fits the spot. To do this,
select the Advanced integration tab of Processing options. <em>Check
the central spot profiles for the images used in the cell refinement.</em></p>
      </td>
      <td><br>
      </td>
      <td valign="top">
      <p><img src="images/img_053_8.2.3_central_profile.png" style="width: 382px; height: 252px;" alt=""> </p>
      </td>
    </tr>
  </tbody>
</table>

<h3><a class="mozTocH3" name="mozTocId943675"></a><font face="Times New Roman, serif"><font size="3"><b>8.2.4
The summary window</b></font></font></h3>

<table cellpadding="2" cellspacing="2">

  <tbody>
    <tr>
      <td valign="top">
      <p>This window presents a summary of how selected parameters have
changed in different cycles of the cell refinement. The behaviour of
these parameters gives a good indication of whether the cell refinement
has been successful.</p>
      <p>If the refinement has been successful, the RMS residual should
be lower for the final cycle than in previous cycles. However, errors
in the cell can be compensated quite well by changing the crystal to
detector distance, so the differences are not always dramatic.</p>
      <p>The other parameters that can be plotted from the pull-down
list are the detector distance and the Pixel ratio (Yscale). <br>
      </p>
      </td>
      <td><br>
      </td>
      <td valign="top">
      <p><img src="images/img_054_8.2.4_cellref_summary.png" style="width: 399px; height: 285px;" alt=""> </p>
      </td>
    </tr>
  </tbody>
</table>

<p>The detector distance should be the same for all images in the
refinement. If the original indexing was based on auto-indexing a
single image (say the first), then the detector distance might change
for images from the second segment to compensate for an error in the
original cell. If the variation in distance for different images
increases with the cycle number, this indicates that the refinement
is not stable.</p>

<p>The Pixel ratio (Yscale) parameter may also show an initial
variation for images in different segments, because refining Yscale
(which should be 1.0000 for all except Raxis II and Raxis HTC
detectors) can compensate for errors in cell dimensions in the same
way that the distance can. The final values (last cycle) should be
very close to identical for all images and should also be very close
to unity (to within 0.0010).</p>

<p>Cell refinement can be unstable if the data do not extend to at
least 3.5 Å. If it appears unstable, use the cell derived from
auto-indexing a series of images well spaced in φ instead.</p>

<p><em>Examine the plots to see if the parameters are stable and
correct (Yscale).</em></p>

<h3><a class="mozTocH3" name="mozTocId657403"></a><font face="Times New Roman, serif"><font size="3"><b>8.2.5
The final results</b></font></font></h3>

<img src="images/img_055_8.2.5_cell_ref_results.png" style="width: 100%;" alt=""><br>

<br>

<p>When refinement has converged (or after 5 cycles) the initial and
final cell parameters and the estimated errors (std. dev.) are listed.</p>

<p><em>If time is available, make a note of the std. dev. values and
repeat the cell refinement using a larger number of images in each
segment. Are the
standard deviations smaller when using more images ?</em></p>

<h2><a class="mozTocH2" name="mozTocId325680"></a><small><span style="font-weight: bold;">8.3 Refining cell parameters for multiple
lattices</span></small></h2>

Providing the resolution is high enough (generally better than ~3.5-3.2
Å)
and not too many of the spots in the different lattices are overlapped,
it is possible to refine the cell parameters for each lattice
individually. The lattice to be refined is selected from the Lattice
selector:<br>

<br>

<img src="images/img_055a_8.3_refine_cell_lattice.png" style="width: 255px; height: 93px;" alt=""><br>

<br>

This selector will be grayed out when processing a single lattice.<br>

<br>

<h2><a class="mozTocH2" name="mozTocId775517"></a><small>8.4 If the
prediction for the first image of a segment is poor</small></h2>

In some cases, depending on how the indexing has been carried out or if
the diffraction is poor or there has been a large change in crystal
orientation during the data collection, the prediction for one or more
of the segments (the first image) may be poor. In such cases the
integration, and hence the cell refinement, may fail. It may be
possible to successfully process the images after an initial refinement
of the crystal orientation using a pattern matching algorithm. To
select this option, got to the Advanced refinement tab of Processing
options and select the tick box for "Refine orientation of first image
in any run by pattern matching" and for "Integrate all images ...".
Then refine the cell in the usual way. During integration, the
orientation will be refined for the first image of each segment; output
for this additional refinement will be written to the logfile, but is
not shown in the GUI.<br>

<br>

<h1><a class="mozTocH1" name="mozTocId907047"></a><font face="Times New Roman, serif">9. Integration</font></h1>

<p>The accurate cell parameters are now used in the integration. Note
that although the images are integrated during the cell refinement,
the intensities are not saved and no MTZ file is generated at that
stage.</p>

<p>It is good practice to start by integrating a block of images
corresponding to a few degrees (5-10°) of data, to check that the
parameters do
not need further adjustment.
MOSFLM will generate warning messages after integration if there are
any difficulties, and it may be possible to improve the situation by
changing some of the default parameters (see&nbsp;<a href="#mozTocId112431" target="_blank">Warning messages</a><a href="#mozTocId112431" target="_blank"> </a>§13).</p>

<p><em>Before integration, ensure that the backstop shadow has been
defined (see&nbsp;<a href="#mozTocId74027" target="_blank">Masked areas
backstop</a> </em>§<em>4.1.1 and&nbsp;<a href="#mozTocId23713" target="_blank">Masked areas general</a><a href="#mozTocId23713" target="_blank"> </a></em>§<em>4.1.2) </em>
</p>

<h2><a class="mozTocH2" name="mozTocId261793"></a><font face="Times New Roman, serif"><font size="4"><b>9.1
Image selection</b></font></font></h2>

<p>Image selection is performed in exactly the same way as in the
cell refinement. In this case, the "Automatic" selection
will simply include all images in the current sector.</p>

<p><em>Select images 1-10</em></p>

<h2><a class="mozTocH2" name="mozTocId647795"></a><font face="Times New Roman, serif"><font size="4"><b>9.2
Setting the MTZ filename and controlling updating of the image
display</b></font></font></h2>

<p>Two icons appear when the integration option is chosen.</p>

<table cellpadding="2" cellspacing="2">

  <tbody>
    <tr>
      <td valign="top">
      <p>If the "Show predictions ..." icon is clicked, the display
window will be updated as each image is processed. This will slow down
the processing, but allows the accuracy of the prediction to be checked
for each image.</p>
      <p><em>Click on this icon so that the display will be updated.</em></p>
      </td>
      <td><br>
      </td>
      <td valign="top">
      <p><img src="images/img_056_9.2_follow_images.png" style="width: 334px; height: 81px;" alt=""> </p>
      </td>
    </tr>
  </tbody>
</table>

<table cellpadding="2" cellspacing="2">

  <tbody>
    <tr>
      <td valign="top">
      <p>The filename of the MTZ file containing the results of the
integration is generated automatically, but can be edited manually.</p>
      </td>
      <td><br>
      </td>
      <td valign="top">
      <p><img src="images/img_057_9.2_MTZ_filename.png" style="width: 334px; height: 81px;" alt=""> </p>
      </td>
    </tr>
  </tbody>
</table>

<h2><a class="mozTocH2" name="mozTocId164196"></a><font face="Times New Roman, serif"><font size="4"><b>9.3
Integrating the images</b></font></font></h2>

<p><em>Click on the Process button to start integration.</em></p>

<p>Integration of the images occurs in two passes. In the first pass,
for each block of images (a number corresponding to a few degrees of
data, selected automatically by
MOSFLM), the detector and crystal parameters are refined for each
image in turn and the "measurement boxes" for all predicted
spots are written to a file for use in the second pass. In the second
pass, the standard profiles are formed from reflections present on
all of the images in this block, and each image is then integrated
and the results written to the MTZ file. The display is not updated
during the second pass, and will remain on the last image of the
block (assuming image updating has been selected).</p>

<p>Note that the unit cell dimensions are normally fixed during
integration, and only the crystal orientation and mosaic spread are
refined. Crystal parameter refinement only starts when a sufficient
number of images have been integrated to provide data for the
post-refinement, typically after ~0.5-1° (more for high mosaicity) .</p>

<h2><a class="mozTocH2" name="mozTocId820258"></a><font face="Times New Roman, serif"><font size="4"><b>9.4
Parameter display windows</b></font></font></h2>

<p>As described in <a href="#mozTocId639269">§8.2</a>, the refined
detector and crystal parameters
will be displayed in tables and selected parameters will be plotted
in graphs. The average spot profile for each image will also be
displayed.</p>

<p>The size of these graphs (and the profile) can be expanded to fill
the whole window by holding down "Shift" and clicking LMB
anywhere in the graph window. A second "Shift+click" will
revert the graph to the original size.</p>

<p>In addition to these windows, there are windows that tabulate and
plot (as a function of image number) the mean I/σ(I) for profile
fitted and summation integration intensities. The overall values and
the values for the highest resolution bin are given.</p>

<p>The number of overloaded reflections, "Bad spots" (ie those that
fail certain tests, see <a href="#mozTocId979076"><span style="text-decoration: underline;">mosflm</span></a><a href="#mozTocId979076"> SUMMARY file</a>
§15), Spatial overlaps and, if processing multi-lattice images, the
number of lattice overlaps is listed for each image and can be plotted
by highlighting that parameter. When processing data from crystals with
large unit cells, it is important to watch out for spatial overlaps
(see <a href="#mozTocId324820">§9.7</a> for tips on how to reduce the
number of spatial overlaps if this is a problem). <br>
</p>

A display of the standard profiles for different regions of the
detector is also provided. Poor profiles are "averaged", by
including reflections from inner regions of the detector. Averaged
profiles are indicated by a red line around the spot (rather than
blue). The original "unaveraged" profile can be viewed a
clicking on the profile (providing there were sufficient spots in
that region to allow formation of a profile).
<p><img src="images/img_058_9.4_profiles.png" style="width: 347px; height: 215px;" alt=""><br>
</p>

<p><em>The profiles should be checked to see that they are well
defined and centred within the box. Poorly-defined, diffuse or
non-centred profiles may suggest that the prediction is not very
good, in which case this should be checked on the corresponding
image(s).</em></p>

<p>It may be useful to expand the standard profiles to fill the
window using "Shift + click" in the profiles window.</p>

<p>Finally, the lower left window plots I/σ(I) as a function of
resolution for any selected image.</p>

<p><img src="images/img_059_9.4_Ioversigma_histo.png" style="width: 344px; height: 182px;" alt=""><br>
</p>

<p>Different parameters can be plotted by selecting the small right- or
left-pointing arrows on the title line above the plot.</p>

<h2><a class="mozTocH2" name="mozTocId595790"></a><b>
9.5 Integrating the whole dataset</b></h2>

<p>Assuming that everything looks OK, the entire dataset can now be
integrated. However, it is strongly recommended that
Project/Crystal/Dataset names are assigned first. These are written
to the output MTZ file and used by downstream programs, in particular
AIMLESS will use this information when deciding which images belong to
the same dataset.</p>

<p>Select "Experiment settings" from the "Settings"
drop-down menu (see&nbsp;<a href="#mozTocId626255" target="_blank">Drop
down menus</a> §2.1) to enter these names and optionally give a title
for the MTZ file.</p>

<p style="font-style: italic;">Select images 1-84 and click on
"Process".</p>

<h3><a class="mozTocH3" name="mozTocId15993"></a>
9.5.1 Parallel Integration Using multiple cores</h3>

<p>An option is available on the pull-down menu (next to the "Process"
button in the Integration task) which splits up the integration job
over available cores on the local machine. All aspects are currently
determined automatically at present; user-configurable options will be
available in a later version. The algorithm used is as follows:<br>
<br>
iMosflm determines the number of cores available on the local machine.<br>
If the number of cores (N) is greater than 2, iMosflm splits the
integration run into N-1 batches (up to a maximum of 16) containing
approximately the same number of images. If N ≤ 2, iMosflm splits the
run into N batches.<br>
<br>
If the total number of images in each batch is less than 32, the number
of batches is decreased until this condition is satisfied.<br>
<br>
The first batch is submitted as a background task, consisting of a
refinement stage and an integration stage, with its input and output
files (including the MTZ file) in a new directory, its name being
determined from the number of segments of data being integrated, and
the lattice number (if the sample has been determined to contain
multiple lattices). If the directories exist already, they are all
moved into a newly-created directory with a time-stamped name; the
files from the most recent integration run are thus in directories with
names following the pattern described above. Once the refinement stage
is complete, the refined parameters are written to a file.<br>
<br>
The launch of subsequent batches are delayed until the corresponding
preceding batch has written its refined parameters. This file is read,
and the new batch is launched, again with a refinement stage and
integration stage.<br>
<br>
At present, the job cannot be aborted once it has started.</p>

<h3><a class="mozTocH3" name="mozTocId245100"></a>9.5.2
Integrating as a background job</h3>

<p>By selecting "Batch" in the drop-down menu adjacent to
the Process button, the integration can be run as a background job
rather than interactively, and the GUI can be used to look at a
different dataset. </p>

<p>
Selecting "Batch" from the drop-down menu will display a new window
showing the script that will be used to process the images, along with
a number of processing options. The script can be edited if additional
keywords are required or if some parameters are to be changed, and can
also be copied and pasted into a file for off-line processing. </p>

<p>
By default, the job is divided into batches across multiple cores as
determined for the parallel integration described in §9.5.1, but the
number of cores can be chosen by the user from a drop-down menu; in
this case, the size of each batch is determined
by the interface.
</p>

<p>
Plotting the results of the integration can be turned off; this can
make
processing much faster.
</p>

<img src="images/img_060_9.5.2_batch.png" style="width: 100%; height: 664px;" alt=""><br>

<p><br>
</p>

It is possible to configure
job submission for remote machines (which can be added by depressing
the "add host" button). Ensure you have enabled passwordless logins
for all the remote machines you enter and that you specify the full
path to
the Mosflm executable in the "Batch destinations" window. The remote
working directory
(in which the log and MTZ files are written) and the remote image
directory must both be specified with their full path names. Any
required parameter fields that are not
completed by the user are highlighted in orange; if the user tries to
submit a job without completing these fields, a new window containing
only those fields
(again highlighted in orange) pops up with a request to do so.
<p>The number of cores available on the selected host can be determined
by
depressing the "apple core"&nbsp; button on the "Batch destinations"
configuration
window.
</p>

<p><img src="images/img_060b_9.5.2_batch_destinations.png" style="width: 448px; height: 323px;" alt=""><br>
</p>

<br>

<p>
The log file for batch submission jobs, the MTZ and SUMMARY files are
written to the directory in which iMosflm was launched.</p>

<h2><a class="mozTocH2" name="mozTocId905962"></a><font face="Times New Roman, serif"><font size="4"><b>9.6
Checking the integration</b></font></font></h2>

<p>The detector and crystal parameter plots should be examined
carefully to check for any instability in the refinement. If there
are large and random variations in some parameters (e.g. the detector
twist and tilt) then it may be better to fix them and repeat the
integration.</p>

<p>For cases (eg very small unit cells) where there are very few
suitable reflections on each image, the refinement of the missetting
angles may show significant variations from one image to the next. In
such cases it is best to apply smoothing to the missetting angles,
using the tick box in Settings -&gt; Processing options -&gt; Advanced
Refinement. <br>
</p>

<p>Discontinuities due to blank images should also show up,
and the offending images should be removed from the scaling run.</p>

<p>If adjacent spots are incompletely resolved on the detector, it
may be possible to improve the processing by increasing the PROFILE
TOLERANCE parameters by 1-2%. These parameters can be set in the
Advanced integration tab of the Processing options menu (use
Settings).</p>

<h2><a class="mozTocH2" name="mozTocId324820"></a><font face="Times New Roman, serif"><font size="4"><b>9.7
Advanced features for integration</b></font></font></h2>

<p>The "Settings -&gt; Processing options" menu
allows additional control over the integration. Parameters such as
the minimum spot separation, resolution limits, excluded resolution
ranges, block size, MTZ
filename and BATCH ADD can be changed in the Processing tab. <br>
</p>

<p>Manually&nbsp; decreasing the "minimum spot separation" can help if
a large number of reflections are flagged as spatially overlapped (red
boxes). The prediction must be updated to see the effect of changing
the separation, this can be done either by displaying the next or
previous image, or double clicking on the blue circle next to the image
currently displayed in the Images pane. <br>
</p>

<p>In the
Advanced integration tab, the measurement box parameters, profile
tolerance and profile averaging parameters can be set. <br>
</p>

<p>The measurement box parameters can be adjusted for rare cases where
the estimation of the spot size has not worked correctly, resulting in
a box that is too small or too large. The optimisation of the
background rim and corner cutoff parameters that determine which pixels
are used for the background and which pixels for the peak can also be
turned
off, but this is generally not recommended.<br>
</p>

<p>Increasing the profile tolerance can help in cases where adjacent
spots are not completely resolved, this can be judged by examining the
standard profiles. By default, the profile tolerance is automatically
increased if there are a large number of spatial overlaps, as this has
the effect of reducing the "minimum spot separation". A message will be
written to the logfile if this has happened. This option can be turned
off&nbsp; using the tick box "Optimise profile tolerance values to
avoid spot overlap". <br>
</p>

<p>The profile outlier exclusion parameters control the exclusion of
ice spots or hot pixels which could otherwise corrupt the standard
profiles.</p>

<p>Pixels with a value less than the "Null pixel threshold" are
considered to belong to inactive regions of the detector.</p>

<p>The pixel saturation value determines when a reflection is
considered to be an overload. The intensity of overloaded reflections
is estimated by profile fitting, but these reflections are rejected by
the scaling program AIMLESS by default.<br>
</p>

<p>Increasing the "Maximum reflection width in φ " from the default
value of 5° will reduce the number of rejected reflections (green
boxes) and is worthwhile when the mosaicity is very high or the mosaic
block size is very small. As with the minimum spot separation, the
image must be refreshed to see the effect of changing this parameter.</p>

<p>The rejection criteria will reject reflections with too much
variation in the background (BGRATIO) or where the gradient of the
background plane is too large. These should only be changed if many
reflections are being rejected. PKRATIO only applies to fully recorded
reflections, and reflects a very poor profile fit. With current data
collection protocols there will be very few (if any) fully recorded
reflections.<br>
</p>

<p>Additional MOSFLM parameters will be added based on user requests.
</p>

<h2><a class="mozTocH2" name="mozTocId906112"></a><small>9.8
Integrating multiple lattices</small></h2>

When multiple lattices have been successfully indexed, each lattice can
be integrated individually by selecting the appropriate lattice number:<br>

<br>

<img src="images/img_060a_9.8_integrate_lattice.png" style="width: 400px; height: 98px;" alt=""><br>

<br>

Reflections in the chosen lattice that are overlapped by a reflection
from another lattice will be integrated, but the measurement box will
be expanded so that the total intensity of the two (or more)
reflections is measured. These reflections will be flagged for special
treatment. Reflections that are not overlapped are referred to as
"singletons". They will be dealt with in the normal way by POINTLESS
and AIMLESS. <br>

<br>

<span style="font-weight: bold;">NOTE: If more than one lattice has
been indexed, and the results of integrating just ONE of the lattices
are to be checked by running QuickSymm or QuickScale, then the
multi-lattice icon in the Integration pane must be turned off,
otherwise an error message will be given saying that all lattices must
be integrated.</span><br>

<br>

It is often the case that by measuring both lattices (in
separate integration runs), and inputting both MTZ files to QuickScale,
the overall completeness is high using ONLY the singletons. To use this
option, ensure that the multi-lattice icon is off.<br>

<br>

To make use
of the intensity estimates for overlapped reflections, MTZ files for
all lattices must be input to the
program FECKLESS, which will derive the best estimate of the summed
intensity. This is the default option if more than one lattice has been
indexed and it requires that all lattices have been integrated (in
separate runs) prior to running QuickSymm or QuickScale (FECKLESS will
be run automatically). <br>

<br>

At this time, no downstream programs
can make use of the summed intensities of overlapping reflections, but
in the future it should be possible to use this data in REFMAC.<br>

<br>

Currently, it is recommended to use only singletons from all the
lattices; FECKLESS is not required in this case.<br>

<br>

The MTZ filename is automatically updated to reflect which lattice has
been chosen, to avoid overwriting the MTZ file of the first lattice
when
integrating the second one. FECKLESS when run from iMosflm relies on
this naming convention, so do not change it.<br>

<br>

<h1><a class="mozTocH1" name="mozTocId868502"></a><font face="Times New Roman, serif">10. Running
Pointless to check the symmetry</font></h1>

<p>Once the images have been integrated (even a few degrees of data in
many cases) the program POINTLESS can be run to determine the true Laue
symmetry and try to determine the space group using the QuickSymm
button.</p>

<img src="images/img_061_10_run_pointless.png" style="width: 100%;" alt=""><br>

<p><br>
<span style="font-style: italic;">Select the QuickSymm button. </span><br>
</p>

<p>A summary of the Pointless results as
shown below will appear in a "qtRView" window.</p>

<img style="width: 962px; height: 748px;" alt="" src="images/img_062_pointless.png">
<p><br>
</p>

<p>Various graphs (L test for twinning, ViewHKL to view the reciprocal
lattice) can also be viewed in this window.</p>

<p>Various options for POINTLESS, such as a reference MTZ file, forcing
the symmetry selected in iMosflm and specifying multiple input MTZ
files can be selected from the Settings -&gt; Processing options -&gt;
Sort Scale and Merge tab (see below).<br>
</p>

<img src="images/img_063_10_pointless_options.png" style="width: 664px; height: 872px;" alt=""><br>

<p><b>Caution: The results can be ambiguous if run with a partial
dataset. Look in the logfile to see how many reflections are used to
test each possible symmetry operator.<br>
</b></p>

<h1><a class="mozTocH1" name="mozTocId420086"></a><font face="Times New Roman, serif">11. Running
Aimless to scale and merge the data</font></h1>

<p><span style="font-style: italic;">Select the QuickScale button. </span><br>
</p>

<p>This will first run POINTLESS then
change the space group for the data to that selected by POINTLESS
(unless the iMosflm symmetry is set to override POINTLESS), run
AIMLESS to scale and merge the data in that space group and then run
CTRUNCATE which calculates a number of statistics from the intensity
data. The CCP4 UNIQUEIFY script will then be run which generates all
the unique reflections for that spacegroup to the resolution of the
measured data and will flag reflections
(5% by default, but this can be changed) for use as the Rfree set.<br>
</p>

<p>AIMLESS can be run from the QuickScale button either treating
anomalous data (the default) or ignoring anomalous data. If only
processing a few degrees of data it is usually better to ignore
anomalous because, especially for low symmetry cases, no merging
statistics may be given in AIMLESS. <br>
</p>

SCALA can be selected as an alternative to AIMLESS for scaling <span style="font-weight: bold;">(not recommended).</span><br>

<p>There is limited control over running AIMLESS (see figure above),
including re-setting resolution limits, rejecting batches (images),
changing the treatment for accepting partials, changing the rejection
criterion and changing the procedure for updating the standard
deviation estimates.</p>

<p>&nbsp;The AIMLESS results will be displayed in the qtRView,
as shown below, along with graphical output (see below) and the full
log file
can also be examined. </p>

<p>Aimless summary file:</p>

<img style="width: 1186px; height: 791px;" alt="" src="images/img_064_11_qtrview_aimless_part1.png"><br>

<p><br>
</p>

<p><img style="width: 1179px; height: 509px;" alt="" src="images/img_064a_11_qtrview_aimless_part2.png"><br>
</p>

<p><br>
</p>

<p>An example of the Aimless graphical output:</p>

<p><img src="images/img_064a_11_aimless_graph_qtrview.png" style="width: 100%; height: 703px;" alt=""></p>

<br>

The AIMLESS logfile can also be examined by selecting the "Log File"
tab.<br>

<br>

<h1><a class="mozTocH1" name="mozTocId49119"></a><font face="Times New Roman, serif">12. History
and mosflm log file</font></h1>

<p>Selecting History allows the history of the session to be
examined, or, by selecting the Log tab, the full mosflm.lp file can
be viewed. The mosflm.lp file is also available in a time-stamped file,
mosflm_<i>yyyymmdd_hhmmss</i>.lp, (e.g. mosflm_20100518_131019.lp) and
can be read
with a text editor.</p>

<p>The History has a tree structure, and will show when various
parameters have been changed. This has not been fully implemented and
is not generally useful.</p>

<p>The logfile may provide useful clues when processing has failed.<br>
</p>

<h1><a class="mozTocH1" name="mozTocId112431"></a><font face="Times New Roman, serif">13. Warning
Messages</font></h1>

<p>As already mentioned in&nbsp;<a href="#mozTocId452208" target="_blank">Adding images</a> §3 and&nbsp;<a href="#mozTocId4846" target="_blank">Integration</a> §9, warning messages are
generated by MOSFLM during processing. A "traffic light" colour coding
has now been assigned based on the warnings and is shown next to the
Warnings box:</p>

<p><img src="images/img_065_13_traffic_light.png" style="width: 162px; height: 42px;" alt=""><br>
</p>

<p>A Red status implies a serious problem that will affect data quality
and should be addressed.</p>

<p>An Orange status implies minor issues that should be checked to see
if things can be improved.</p>

<p>A Green status means no significant problems, messages are for
information only.<br>
</p>

<p> Abbreviated messages
can be obtained by clicking on the "Warnings" icon.
The full warning Details together with Hints &amp; Notes text (if any
are available) can be obtained by double-clicking the relevant
warning. Details are displayed in a pop-up text box which will
disappear with the next click outside the box. The same full details
and suggestions are, of course, available in the mosflm.lp files where
even
more information may be available.</p>

<table border="2" bordercolor="#ff0000" cellpadding="2" cellspacing="2">

  <tbody>
    <tr>
      <td>
      <p><b>NOTE This is the end of the part of the tutorial which
deals directly with iMosflm but see<a href="#mozTocId991006">&nbsp;</a></b><a href="#mozTocId991006">§</a><b><a href="#mozTocId991006">19</a> which
has some suggestions for further work if you have time. The remainder
of this document deals with integrating and scaling data with MOSFLM
and Aimless via the CCP4i user interface, examining the traditional
mosflm SUMMARY file with the CCP4 utility loggraph.</b></p>
      <p><b>The Appendix contains a shell script for running MOSFLM as
a traditional batch job.</b></p>
      </td>
    </tr>
  </tbody>
</table>

<h1><a class="mozTocH1" name="mozTocId251449"></a><font face="Times New Roman, serif">14. Useful command line options</font></h1>

iMosflm has a number of command line options, and these can be listed
by typing:<br>

imosflm --help<br>

Current options are:<br>

<br>

--allimages, -a &lt;filename&gt; <br>

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
Starts mosflm loading all files that match the template<br>

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
generated from &lt;filename&gt;<br>

--ccp4i2&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Autosaves an iMosflm
session file upon exit<br>

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
with an XML list of all iMosflm output files.<br>

--debug, -d&nbsp;&nbsp;&nbsp; Creates a large output file for debugging
purposes<br>

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
Don't use this unless asked to by a developer<br>

--expert, -e&nbsp;&nbsp; Permits access to advanced detector settings.<br>

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
This should not normally be required<br>

--fastload, -f Attempt to speed loading of many images offline<br>

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
while indexing two default images separated by<br>

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
90 degrees<br>

--help, -h&nbsp;&nbsp;&nbsp;&nbsp; Displays this message, then exits<br>

--imagedir, -I &lt;directory&gt;<br>

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
Starts the image browser in this directory; if &lt;directory&gt;<br>

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
is given as an environment variable, it will be expanded<br>

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
to its full value<br>

--init, -i &lt;filename&gt;<br>

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
Starts Mosflm and reads from the given saved session file<br>

--startdir, -S &lt;directory&gt;<br>

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
Starts mosflm in directory &lt;startdir&gt; rather than the current<br>

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
directory. This will only work if the directory exists and <br>

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
you have write permission to it, otherwise iMosflm will exit.<br>

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
All the normal mosflm output files will be in this directory<br>

--singleimage, -s &lt;filename&gt;<br>

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
Starts mosflm loading only the image from &lt;filename&gt;<br>

--site, -X&nbsp;&nbsp;&nbsp; &lt;filename&gt;<br>

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
Reads any/all of the following lines from the file given<br>

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
WAVELENGTH &lt;x&gt;<br>

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
DISPERSION &lt;x&gt;<br>

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
POLARISATION [ &lt;x&gt; | PINHOLE | MIRRORS | MONOCHROMATOR |
SYNCHROTRON &lt;x&gt;]<br>

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
DIVERGENCE &lt;xh xv&gt;<br>

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
BEAM &lt;beamx beamy&gt;<br>

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
DISTANCE &lt;x&gt;<br>

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
DISTORTION TILT &lt;x&gt;<br>

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
DISTORTION TWIST &lt;x&gt;<br>

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
GAIN &lt;x&gt;<br>

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
DETECTOR REVERSEPHI<br>

&nbsp;&nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;
PIXEL &lt;x&gt;<br>

&nbsp;&nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;
ADCOFFSET &lt;x&gt;<br>

&nbsp;&nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;
NULLPIX &lt;x&gt;<br>

&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp; DETECTOR OMEGA &lt;x&gt;<br>

--version, -v&nbsp; Displays the program version and required Mosflm
version, <br>

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
then exits<br>

<br>

These can be abbreviated to the shortest unambiguous string<br>

<br>

<h2><a class="mozTocH2" name="mozTocId323598"></a>14.1 The site file</h2>

"imosflm --site &lt;sitefile&gt;" will read keywords from the file
&lt;sitefile&gt; that will overwrite incorrect information in image
headers. This saves having to manually correct values in every iMosflm
session. The site file can also be read or written as an option from
the Session menu (see&nbsp;<a href="#mozTocId647094" target="_blank">Drop
down menus</a> §2.1). Allowed keywords are:<br>

WAVELENGTH &lt;x&gt;<br>

DISPERSION &lt;x&gt;<br>

POLARISATION [&lt;x&gt; | PINHOLE | MIRRORS | MONO | SYNCHROTRON
&lt;x&gt;]<br>

DIVERGENCE &lt;xh xv&gt;<br>

BEAM &lt;beamx beamy&gt;<br>

DISTANCE &lt;x&gt;<br>

DISTORTION TILT &lt;x&gt;<br>

DISTORTION TWIST &lt;x&gt;<br>

GAIN &lt;x&gt;<br>

DETECTOR REVERSEPHI<br>

PIXEL &lt;x&gt;<br>

ADCOFFSET &lt;x&gt;<br>

NULLPIX &lt;x&gt;<br>

DETECTOR OMEGA &lt;x&gt;<br>

<br>

<h1><a class="mozTocH1" name="mozTocId979076"></a><font face="Times New Roman, serif">15. The mosflm SUMMARY file</font></h1>

<p>MOSFLM produces a summary file listing refined parameters for each
image, and when using iMosflm this file will be date- &amp;
time-stamped and have a name such as "mosflm_20100518_131019.sum".
This contains the same information as the plots produced by the
iMosflm GUI which now also include the number of "bad spots"
and overloads.</p>

<p>This can be inspected graphically at the command line (&gt;loggraph
mosflm_20100518_131019.sum) or from the CCP4i GUI. Using CCP4i, select
the pull down menu "View Files from
Job" and under Output files.. select Additional log graphs..
where the *_SUMMARY.loggraph file will be listed. Select this file to
display its tables in loggraph.</p>

<p>This is very useful to identify "rogue" images (with
unusually high positional residual, or low I/σ(I)). If you find any,
read that image into MOSFLM and see what is wrong with it.</p>

<p>If you have done more than one integration run during your MOSFLM
session, you will find multiple entries of the tables. Look at the
last set for integration of the 84 images.</p>

<p>Click on the "Refined detector parameter" tables and
check on the stability of parameters like the TILT and TWIST of the
detector (units are hundredths of a degree) and, for Mar Research (or
DIP) image plate data, the distortion parameters ROFF and TOFF (units
are mm). If they are varying a lot (more than 20 for TWIST/TILT) or
0.15 for ROFF/TOFF then it is probably a good idea to fix these
parameters at the average value (or the known values for this
detector, if they are available) (see&nbsp;<a href="#mozTocId591178" target="_blank">Detector parameters</a> §8.2.1). </p>

<p>Click on the "Post refinement" table and check the
missets. It does not matter if they change slowly and by an amount
(per image) that is less than 0.1*mosaic spread. If they are changing
more than this then there could be a problem with processing the data
(there is not much you can do about this).</p>

<p>Check how the mosaic spread is changing. If it is unstable, or if
you think it is not refining to sensible values (as judged by looking
at the prediction) then you can fix the input value in the same way
as the detector parameters (see&nbsp;<a href="#mozTocId302335" target="_blank">Crystal parameters</a> §8.2.2).</p>

<p>BADSPOTS AND OVERLOADS</p>

<p>The program will set a rejection flag for those reflections that
fail certain tests, for example too much variation in the background
level, a poor profile fit, an intensity that is very negative (more
than 5 standard deviations), a very high gradient for the background
plane. These reflections are called "Bad spots" and they
are listed individually for each image in the mosflm.lp file,
together with the reason for flagging them. The number of bad spots
is also written to the summary file. Generally there should be very
few (5-10) bad spots on each image. If there are more, it could be
because the backstop shadow is not correctly allowed for (consider
using the NULLPIX keyword). </p>

<p>There should also be very few overloaded reflections on each
image. If there are a lot, then a separate low resolution data
collection pass should be made with a much shorter exposure time.</p>

<p><b>IMPORTANT</b>: Both "Bad spots" and "Overloads"
are written to the output MTZ file, but will be rejected by default
by AIMLESS. The intensity of overloaded reflections is estimated by
profile fitting that part of the spot that is not saturated. To
include these reflections in the final merged data, use the ACCEPT
keyword in AIMLESS.</p>

<h1><a class="mozTocH1" name="mozTocId464596"></a><font face="Times New Roman, serif">16. Scaling
data with CCP4i</font></h1>

<pre class="western" style="margin-right: 1cm; margin-bottom: 0.5cm;">% ccp4i</pre>

<p>Select "Directories &amp; ProjectDir" (top right)</p>

<p>In the new window, select "Add project"</p>

<p>Enter the project name in the 'Project' field and the full
directory path in the 'uses directory:' field. Default values may
have been entered already here. Select this project from "Project
for this session..."</p>

<p>Select "Apply and Exit" ... Dismiss the warning message
that comes up</p>

<p>Select "Data reduction" from the pull down menu of
modules (orange bar at top left)</p>

<p>Select "Symmetry, Scale, Merge (Aimless)"</p>

<p>In the window that appears do the following:</p>

<p>Give a job title (top line)</p>

<p>Click on the box next to "Separate anomalous pairs for
outlier rejection &amp;
merging statistics" (the crystals have been soaked in a mercury
compound)</p>

<p>In the next orange bar (line starts "HKLIN #1") select
Browse and select the MTZ file output by MOSFLM (probably called
hg_001.mtz) Select "OK"</p>

<p>If you did not supply the Project name, Crystal name or Dataset name
to Mosflm, fill in the boxes for these now</p>

<p>Under "Scaling Protocol":</p>

<p>From the pull-down menu on the line starting "Scale",
select "with automatic default settings"</p>

<p>At the bottom of window, from the pull-down menu named "Run"
select "Run&amp;View Com File"</p>

<p>This will display a new window showing the command file for
running the "POINTLESS" step, select "Continue". After
a brief pause it will show the command file for running AIMLESS. (This
can be edited before submitting the job). Select "Continue"</p>

<p>In the main window, it will show that the AIMLESS job is running</p>

<p>When AIMLESS has finished, the command file for running the
CTRUNCATE step will appear...select "Continue"</p>

<p>When CTRUNCATE has run, the main window will say "FINISHED"</p>

<p>At that point, select the pull-down menu "View Files from
Job" and select "View Log Graphs". This will give you
the same graphs as running loggraph on the AIMLESS log file; they are
also the same
as those that appeared in IMOSFLM's "QuickScale" task. To look at
the log file itself (e.g. the overall merging statistics) select "View
Log File" and it will appear in a new window</p>

<h2><a class="mozTocH2" name="mozTocId16713"></a><font face="Times New Roman, serif"><font size="4"><b>16.1
Looking at the AIMLESS output</b></font></font></h2>

<p>The simplest way to look at the output from AIMLESS is to use
loggraph on the AIMLESS log file (or via the CCP4i GUI). This can
display many different graphs.</p>

<p>Use "Scales vs rotation range" to check for smooth
variation in the scale factor. Check the variation in B factor with
image, and if there is no real variation it is best to turn off the
B-factor refinement.</p>

<p>Use the "Analysis against all Batches for all runs, to detect "bad"
images (high R-factor, large number of rejected spots).</p>

<p>Check the "Analysis against resolution" Fractional bias
to see if there is any indication of "Partial bias" (A
negative partial bias will result if the mosaic spread is
underestimated, or if there is a lot of diffuse scatter. </p>

<p>The Fractional bias should be less than 1-2%, although it will
often exceed this for weak data (e.g. in the high resolution bins).</p>

<p>The "Axial reflections" graphs in AIMLESS are useful for detecting
systematic absences, which can be used to identify the true space
group. However, the detection of screw axes is thought to be
sufficiently robust in POINTLESS that these graphs are no longer
necessary.</p>

<p>It can also be useful to look at the AIMLESS log file itself, in
particular the table giving statistics as a function of resolution.
The effective resolution limit of the data can be estimated by
looking at the Mn(I)/sd column (this is the mean I/σ(I) AFTER
merging symmetry mates, and is the best indicator of data quality).
This table also shows shell and cumulative R-factors.</p>

<p>The Mn(I)/sd values depend on having realistic values of the
standard deviations (errors) in the intensities. As the values that
come from MOSFLM are always underestimates of the true error, these
values are scaled up in AIMLESS using a three-term correction:</p>

<p>sdcorrected = SdFac * Sqrt[sd(I)**2 + SdB*LP*I + (SdAdd*I)**2]</p>

<p>Here "SdFac" is an overall scale factor, and "SdB"
and "SdAdd" are intensity dependent factors.</p>

<p>AIMLESS will automatically work out a suitable value for all three
parameters, in order to make the mean value of (observed
scatter)/(sdestimate) equal to 1.0, where "observed scatter"
is the difference between an individual estimate of intensity and the
mean of all other estimates (from symmetry mates).</p>

<p>
Probably the best estimate of the true high resolution limit of the
data can be obtained from the CC(1/2) values; these are the
correlations between
equivalent observations that have been divided randomly into two
half-datasets. The resolution limit is found when the CC drops below ~
0.5 - 0.3.
</p>

<p>This table comes under the heading:</p>

<p>ANALYSIS OF STANDARD DEVIATIONS </p>

<p>in the AIMLESS log file and 'Run <i>n</i><span style="font-style: normal;">,
standard deviation v. Intensity, test' (where </span><i>n</i> <span style="font-style: normal;">is
1 or more) in the CCP4i GUI 'View Files from Job' - 'View Log Graphs'
display.</span></p>

<p style="font-style: italic;">Can you identify a bad image in this
dataset ? Can you work out
why it is bad ?</p>

<p>(Clue...the image headers contain quite a lot of information that
is not used by MOSFLM, including the date and time that the image was
collected).</p>

<p>You can exclude a given batch from the scaling using the EXCLUDE
keyword:</p>

<p>RUN ALL EXCLUDE imagenumber</p>

<p>In this case, run number will be "1".</p>

<p><span style="font-style: italic;">Rerun the scaling,</span> SENDING
THE OUTPUT TO A NEW LOGFILE, excluding
this image, and see the effect on the heights in the anomalous
Patterson (in the log file). DO NOT repeat the integration. In the
command file, uncomment the line (near the top) "goto aimless"
so it skips the integration part.</p>

<p>In the CCP4i GUI click to highlight the AIMLESS job which is listed
as FINISHED and select “ReRun Job..” from the control buttons
down the right-hand side of the main interface window. Under
“Excluded Data” in the window that appears, check the box next to
'Exclude selected batches' and pull-down on the menu button to
exclude a 'range'. Give the start &amp; end range to exclude (e.g. 74
to 74). Rerun the job as before.</p>

<h1><a class="mozTocH1" name="mozTocId44933"></a><font face="Times New Roman, serif">17. Changing
the symmetry</font></h1>

<p>From the list of options at the left hand side of the main window,
select “Utilities” and under that "Sort/Modify/Combine MTZ
Files"</p>

<p>In the new window give a new title, e.g. reindex as H32</p>

<p>Click on the Box "Change space group and/or reindex
reflections"</p>

<p>Use the "browse" option to select the input MTZ file
(First orange bar), the output filename will be generated
automatically (but you can change it).</p>

<p>Under "Reindex details"</p>

<p>In the last option check the box next to “Change space group to”
and enter H32 in the box. This is above the final item, "Reduce
reflections to the asymmetric unit ", which is checked by
default.</p>

<p>Select "Run" from the "Run" option button.</p>

<p>Then go back to the scaling window, and select the new MTZ file
(reindexed) as the input for scaling (use "Browse"). CHANGE
THE JOB TITLE</p>

<p>Then select "RUN"</p>

<p>The scaling will now be performed in space group H32. Look at the
merging statistics in the log file, in particular the multiplicity
weighted R-factor, called Rmeas in the log file.</p>

<h1><a class="mozTocH1" name="mozTocId252763"></a><font face="Times New Roman, serif">18. Looking
at the CTRUNCATE output</font></h1>

<p>The CTRUNCATE program converts intensities to amplitudes, and also
compiles some useful statistics. The LTEST and the "cumulative
intensity statistics" tabulated by CTRUNCATE (and plotted by
loggraph) provide the only point at which you will be able to detect
merohedral twinning (when the two lattices of the twin components
exactly overlap, and every measured intensity is actually the sum of
two intensities).</p>

<p>For a good dataset, the observed distribution should be within 1%
of the theoretical distribution. Is this the case for this data?</p>

<h1><a class="mozTocH1" name="mozTocId991006"></a><font face="Times New Roman, serif">19. If you
have time ...</font></h1>

<h2><a class="mozTocH2" name="mozTocId52124"></a><font face="Times New Roman, serif"><font size="4"><b>19.1
Different mosaic spreads</b></font></font></h2>

<p style="font-style: italic;">Try repeating the processing with the
mosaic spread set to a value
25% smaller than the refined one and fix it by checking the "Fix"
box in the Integration window in iMosflm.</p>

<p style="font-style: italic;">Can you tell from the merging statistics
if this data is better?</p>

<h2><a class="mozTocH2" name="mozTocId530274"></a><font face="Times New Roman, serif"><font size="4"><b>19.2
Checking up on outliers</b></font></font></h2>

<p>AIMLESS writes a file called ROGUES which lists reflections which
show very poor agreement between symmetry mates, or which are
implausibly large.</p>

<p>Look in this file (it is ASCII), and try to work out why this has
happened. The ROGUES file gives you the image (Batch) on which the
reflections have been recorded (for partials, this is the image
nearest the centre of the reflection, so you may need to look on the
preceding and following images as well). Select a reflection which
shows very poor agreement with its symmetry mates (A value greater
than 10 in the DelI/sd column in the ROGUES file).</p>

<p>Select the offending image by double-clicking it in the Images
pane of the iMosflm main window or entering the image number in the "Go
to" entry box in the Image Display. The reflections will automatically
be predicted for this image, then enter
the <i>hkl</i> <span style="font-style: normal;">values</span> into
the boxes <span style="font-style: normal;">to</span>
locate the offending reflection in the image. You must give the
measured indices - the first set of values in the ROGUES file - when
doing this. See if there is anything odd about the spot. Remember to
check adjacent images for partials.</p>

<h2><a class="mozTocH2" name="mozTocId364567"></a><font face="Times New Roman, serif"><font size="4"><b>19.3
How accurate does the unit cell have to be?</b></font></font></h2>

<p style="font-style: italic;">Try changing the cell parameters by
(say) 1.0% and integrate the
images again. What is the effect on the merging statistics ?</p>

<h1><a class="mozTocH1" name="mozTocId727216"></a>20. Tips</h1>

<ol>

  <li>When reading images into a session, DO NOT attempt to carry out
any other task until ALL the images have been read.</li>
  <li>It is often worth repeating the indexing (usually only once), as
the refined direct beam coordinates from the first indexing may give an
improved solution when the indexing is repeated (lower rmsd).</li>
  <li>Always integrate a few degrees of data before integrating the
whole dataset (see <a href="#mozTocId907047">§9</a>).
If the space group is not known in advance, run Quicksymm with a few
degrees of data to check that the correct indexing solution has been
chosen.<br>
  </li>
  <li>For difficult images, do not attempt to refine the unit
cell initially; once an indexing solution has been obtained, try
integrating a
few images to ensure that the integration is stable. If then going on
to refine the cell, check that the prediction looks OK for the first
image of every segment included in the refinement. If it does not look
very good, consider using the pattern matching (<big><small>Settings
-&gt; Processing options -&gt; Advanced refinement, </small></big>see&nbsp;
§<a href="#mozTocId775517">8.4</a>).</li>
  <li>If the resolution of the data is less than 3.5 Å, do not use the
“Refine Cell” task. Instead use several images in indexing and use the
cell
that comes from the indexing.</li>
  <li><big><small>If
iMosflm gets into a state where the activity
icon(upper right) is spinning, but nothing seems to be happening, click
on the activity icon to stop it spinning and see if the session can be
continued. DO NOT click on the activity icon simply to abort a task,
this will give unpredictable results. Use the "Abort" button for cell
refinement or integration. There is no defined way to abort indexing.<br>
    </small></big></li>
  <li><big><small>Use the image summation option (see&nbsp; §<a href="#mozTocId44996">4</a>) to get a better impression of the
diffraction for very low exposure Pilatus or Eiger images.</small></big></li>
  <li><big><small>Use image summation for spot finding </small></big><big><small>(</small></big><big><small>Settings
-&gt; Processing options -&gt; Spot finding) </small></big><big><small>and/or
detector parameter refinement </small></big><big><small>(</small></big><big><small>Settings
-&gt; Processing options -&gt; Advanced refinement, </small></big><big><small>see&nbsp;
§<a href="tutorial_7.3.0.html#mozTocId109529">8.2.1)</a> </small></big><big><small>for
fine sliced very weak Pilatus or Eiger images.</small></big></li>
  <li><big><small>For large mosaic spread values (&gt; 1.0°) or small
mosaic block sizes (&lt;10) consider increasing the maximum allowed
reflection width to avoid having too many "green" predicted reflections
(Settings -&gt; Processing options -&gt; Advanced integration,
see&nbsp; §<a href="#mozTocId324820">9.7</a>).</small></big></li>
  <li><big><small>By default, on selecting the Indexing task, iMosflm
will find spots, index and (assuming a solution has been found)
estimate the mosaicity. For difficult cases, it is more useful to
restrict this to simply finding spots, and then do the indexing and
mosaicity estimation by clicking the appropriate buttons. To do this,
change the check box "Automatically index after spot finding" in
Settings -&gt; Processing options -&gt; Indexing.</small></big></li>
  <li><big><small>See&nbsp; §<a href="#mozTocId798805">5.2.1</a> and §<a href="#mozTocId960714">5.2.2</a>
for advice if the indexing fails. Also consider the possibility of a
reversed phi rotation direction if you are not familiar with the
beamline (</small></big><big><small>Settings -&gt; Experiment settings
-&gt; Experiment, </small></big><big><small>see&nbsp; §<a href="#mozTocId626255">2.1</a>)</small></big></li>
  <li><big><small>If the detector parameters have refined to physically
unreasonable values (eg because cell refinement or integration has been
carried out using an incorrect indexing solution) be sure to reset the
detector parameters before attempting further processing </small></big><big><small>(Settings
-&gt; Experiment settings -&gt; Detector, see&nbsp; §<a href="tutorial_7.3.0.html#mozTocId626255">2.1</a>)</small></big></li>
  <li><big><small>Always set the resolution limit slightly beyond the
point at which any spots are visible (see §<a href="#mozTocId890852">4.1.4 </a>).
For very weak fine-sliced data, it can be very difficult to estimate
the resolution visually, so integrate to the maximum resolution
(inscribed circle) and use the merging results to set the final
resolution. There should be no problems integrating to a resolution
~0.3-0.5 Å beyond the actual resolution limit, but, for example,
integrating to 3 Å when the true resolution limit is 5-6 Å may cause
problems, and the integration should then be repeated with a more
realistic resolution limit.</small></big></li>
  <li><big><small>Use the site file </small></big><big><small>§<a href="#mozTocId323598">14.1</a>
if repeatedly processing data where the direct beam position is wrong,
or if the phi direction is reversed or similar issues, in order to avoid having to correct this
for every new session.<br>
    </small></big></li>
</ol>

<br>

<h1><a class="mozTocH1" name="mozTocId654806"></a>21. Known Bugs</h1>

<ol>

  <li>If images within one sector (ie those with the same template)
have different detector distances, this will not be recognised by
iMosflm, the detector distance will be set to that in the header of the
first image. A warning message is given in the mosflm.lp file, but no
warning is given by iMosflm. <br>
  </li>
</ol>

&nbsp;&nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; The mosflm.lp file will
contain a warning similar to that listed below, for a case where the
first image had a detector distance of 250 mm but&nbsp; for a later
image this was reduced to
150 mm:<br>

&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; *****
WARNING *****<br>

&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; *****
WARNING *****<br>

&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; *****
WARNING *****<br>

&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; *****
WARNING *****<br>

&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; Input
crystal to detector distance ( 250.00mm) does NOT agree with value in
the image header ( 150.00mm)<br>

&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; The
input distance will be used.<br>

<br>

<h1><a class="mozTocH1" name="mozTocId11307"></a>22. Processing electron diffraction images</h1>

<br>

<br>

<span style="font-weight: bold;">Introduction</span><br>

There are a number of differences in processing electron diffraction
data compared to X-ray diffraction data. These arise from differences
in the physical detector and the fact that the very short wavelength of
the electron beam results in an Ewald sphere that is almost flat. The
consequences of these differences and the best way to deal with
processing electron diffraction data with iMosflm are described in more
detail below.<br>

<br>

<br>

<span style="font-weight: bold;">The detector</span><br>

Typically CMOS detectors (e.g. from Teitz) are used to collect electron
diffraction data although other detectors (Eiger, Falcon III, Timepix)
have also been used. Usually there is no information in the image
header about the detector (with the exception of the Eiger) and so
iMosflm will not know what the characteristics of the detector are.
There are three basic detector parameters that will have a significant
effect on data processing. These are the gain, the ADC offset and the
pixel value assigned to inactive (or flagged) pixels. <br>

<br>

The gain is the most crucial parameter, as this is used to convert
pixel values to the equivalent number of electrons and Poisson
statistics (which apply to electrons) play a critical role in spot
finding and in rejection of outliers during integration. By default a
gain value of 2.0 is assigned unless this is overridden by a value in
the site-file or set in the Detector parameters (Settings -&gt;
Experiment settings, Detector tab, see <a href="#mozTocId626255">§2.1</a>) . This contrasts with a gain value
of 0.33 for most CCD detectors used for X-ray work, or 1.0 for hybrid
pixel detectors. If the gain is too small, the spot finding will find
many “spots” that are not genuine diffraction spots and if it is too
high it may not find genuine diffraction spots. The default value of
2.0 generally works well, and the program will issue a warning message
after an integration run if the true value differs significantly. This
value should be used to re-process the images.<br>

<br>

The ADC offset is added to the experimental value of all pixels in the
image and is used for CCD detectors to ensure that, even when noise is
present and the dark current has been subtracted, all pixels have a value above zero. For ADSC CCD detectors, for
example, it has a value of 15. This value is subtracted from every
pixel when integrating the images, so if the value is too high it can
lead to X-ray background values that are apparently negative, and this
will generate a lot of rejected reflections and warning messages. It
defaults to zero for electron diffraction images.<br>

<br>
The pixel value assigned to inactive pixels is referred to as the “null
pixel threshold” or “nullpix” value. Any reflection containing a pixel
with a value less than or equal to the nullpix value will be rejected
from detector parameter refinement as being partly in an inactive area
of the detector.&nbsp; If too many pixels have values less than or
equal to the nullpix value the reflection will also be rejected from
integration. This is required
for tiled detectors that have gaps between the modules, so that spots
that overlie the gaps are flagged. However, none of the current CMOS
electron diffraction detectors are tiled, so the nullpix value defaults
to -1, as some pixels may have genuine values of zero. Its value can be
changed using the site-file or via Settings -&gt; Experiment settings,
Detector tab. If many reflections are being flagged as in the inactive
area of the detector a warning message will be given.<br>

<br>

<br>

<span style="font-weight: bold;">The image format</span><br>

The format of the images written by these detectors (with the exception
of the Eiger) is not recognized by iMosflm (or most other data
processing programs) and so a conversion program is used to convert
these to SMV format. These programs are available on the internet
(e.g. <a href="https://cryoem.ucla.edu/downloads">https://cryoem.ucla.edu/downloads</a>) or proprietary software (e.g.
Recorder from temography.com) or can be written in house. It is
important that sufficient metadata is included in the SMV format images
to allow iMosflm to process them. Ideally the following information
should be present:<br>

Size of the image in pixels<br>

Pixel size in mm<br>

Whether images are big-endian or little-endian<br>

Detector distance in mm<br>

Beam coordinates in mm<br>

Wavelength in Å<br>

Start and end oscillation angle of each image<br>

<br>

If this information is not present in the headers, then the pixel
size, detector distance, beam coordinates and wavelength can be supplied
in a keyword driven “site-file” (see below and <a href="#mozTocId323598">§14.1</a>) specified when starting iMosflm
(imosflm --site &lt;sitefilename&gt;), so that these values do not have
to be entered manually every time the program is run (to get a full
list of parameters that can be specified in the site-file and the
appropriate keywords, type “imosflm --help”). The oscillation angle, if
not present, can be entered in iMosflm for the first image (see advanced usage section at the end of <a href="#mozTocId486119"><big><small>§3.0</small></big></a>) and values for all subsequent images are generated
automatically (assuming a constant oscillation angle).&nbsp; There is
not currently any way to specify the image size if this is not in the
image header.<br>
<br>
<span style="font-weight: bold;">The image orientation<br>
<span style="font-weight: bold;"></span></span>If one imagines the 2D
image from the detector as being written as a series of "stripes" of
pixels, then these stripes are always displayed as
vertical lines in the iMosflm image display, with the first pixel
in the first stripe (pixel coordinates 1,1) being in the upper left of
the display. In order to process the images, iMosflm needs to know how
this direction is related to the direction of the rotation axis, ie
whether it is parallel or at right angles to the rotation axis. <br>
<br>
This is
set by the "Detector omega" value, and is displayed in the&nbsp;
Experiment tab of the "Settings -&gt; Experiment settings" window (see <big><small><a href="#mozTocId626255"><big><small>§</small></big>2.1</a>).
A value of 0°&nbsp; or 180° indicates that the rotation axis is
vertical in the image display while a value of 90° or 270° indicates
that it is horizontal. Changing omega by 180° is equivalent to
reversing the direction of the spindle rotation. It is essential that
the correct value for omega is assigned when&nbsp; processing images.
The value is assigned automatically for X-ray experiments based on the
type of detector and the conventional way of mounting that detector on
a beamline (or laboratory source).&nbsp; <br>
<br>
A variety of detectors are used for electron diffraction and the
detector type cannot be assigned from information in the image header,
so the
default value (0°) corresponds to the Tietz CetaD detector after images
have been convered with the tiff2smv program. For other detectors,
examine a series of images looking at spots that lie close to lines
that run horizontally and vertically through the centre of the
images.&nbsp; Spots on one of these lines (eg a horizontal line)
should&nbsp; be present over a longer rotation range than spots lying
close to the other (eg vertical) line. These will be spots that lie
close to the rotation axis. Finding a few such spots will clearly show
if the rotation axis is horizontal&nbsp; (omega 90/270°) or vertical
(omega 0/180°). However, there is still an ambiguity of 180° in the
correct omega value. Because the Ewald sphere is almost flat for
electron crystallography, the images can usually be indexed and
integrated&nbsp;&nbsp; equally well with either alternative&nbsp; (ie
90/270° or 0/180°). The scaling and merging statistics can also be very
similar. However the behaviour of the mosaic spread refinement has been
found to be sensitive to the correct omaga value. Withe the correct
omega value the mosaic spread refines to sensible values, while with
the incorrect value it very quickly refines to a value close to zero
(or even negative). This is currently the best way to determine the
correct omega value.<br>
<br>
Finally, to allow for all possible
orientations of the image, it is usually necessary to consider the
"Invert X
direction TRUE/FALSE" flag. For X-ray diffraction data, it is perfectly
possible to index and integrate a dataset with the incorrect value for
this variable, the data statistics will be identical to those obtained
when using the correct value. However, the signs of all the anomalous
differences will be incorrect, so, for example, an anomalous difference
Fourier map will&nbsp; give negative (rather than positive) peaks at
the sites of anomalous scattering atoms. For electron diffraction there
is no anomalous scattering, and so there is no need to identify the
correct value for this parameter.</small></big><br>


<br>

<span style="font-weight: bold;">The iMosflm site-file</span><br>

This is an ascii file (see §14.1) that can be used to specify a limited number of
parameters that are not expected to change for different experiments,
to avoid having to enter the values manually. An example might be:<br>

GAIN 2.5<br>

BEAM 31.8 33.0<br>

ADCOFFSET 0<br>

<br>

<span style="font-weight: bold;">The electron beam</span><br>

The correct values for the polarization (0.0) and dispersion (0.000005)
of the electron beam will be set by default, but can be changed in
Settings -&gt; Experiment settings-&gt; Experiment tab or specified in the
site-file. The divergence is not critical as the mosaic spread has the
same effect.<br>

<br>

<span style="font-weight: bold;">Indexing</span><br>

As with X-ray data, successful indexing depends on having the correct
direct beam coordinates, wavelength and detector distance. If the
correct values are not in the image header they can be provided in the
site-file or input manually (Settings -&gt; Experiment settings,
Experiment tab).<br>
<br>

Because the Ewald sphere is almost flat, it is not possible to index
using a single image (which is generally possible with X-ray
diffraction). Several images that are separated by at least 20-30°
should be used for indexing. The greater the separation in phi the more
accurate the derived cell parameters will be and the greater the chance
of successful indexing. It is important to check the image display to
ensure that the spot finding has worked correctly, the gain value can
be important for this (see above). It does not matter if some
diffraction spots have not been found, but inclusion of “false” spots
can cause the indexing to fail. <br>

<br>

<span style="font-weight: bold;">Mosaicity estimation</span><br>

For small unit cells the mosaicity estimation can result in a value
that is too small (because too few reflections are generated for each
increment in the mosaic spread) so it is important to check that all
observed reflections are being predicted. If not, the mosaicity will
have to be estimated manually by comparing the predicted and observed
reflections when entering different values of the mosaicity.<br>

<br>

<span style="font-weight: bold;">Cell refinement</span><br>

Typically the cell refinement does not work well for electron
diffraction data. The reason behind this is not clear but is being
investigated. At present this step should be skipped. This means that
it is important to include a wide phi range of images in the indexing
as this will improve the accuracy of the cell parameters.<br>

<br>

<span style="font-weight: bold;">Integration</span><br>The refinement
of the mosaic spread during integration can be unstable, if so it is
best to fix this parameter by checking the “fix”
box. <br>

<br>

The “tilt” and “twist” of the detector (that describe the
non-orthogonality of the incident beam and the plane of the detector by
rotations about the X and Y axes of the detector) are also poorly
defined for electron diffraction experiments, because the diffraction
angles are so small. They can adopt physically unreasonable values
(e.g. several degrees) and be unstable, which will generate warning
messages. Although these large values will have very little effect on
the prediction of the spot positions (and therefore on integration) it
may be preferable to fix both of these parameters. <br>

<br>

Any change in
orientation of the crystal during the experiment is shown in the
refined missetting angles, phix, phiy, phiz. This can reflect genuine
changes in orientation (e.g. due to small physical movements of the
crystal or inaccuracies in the rotation stage) or be compensating for
errors in the unit cell parameters. If there is excessive variation in
these missetting angles they can be smoothed, by clicking the
appropriate check box in the Settings -&gt; Processing options -&gt;
Advanced refinement tab. <br>

<br>

If the mosaic spread of the crystal is large
(e.g. greater than 1°), it may also be necessary to increase the maximum
allowed reflection width in phi (Settings -&gt; Processing options
-&gt; Advanced integration) which defaults to 5°, in order to avoid
a large number of reflections being rejected. A value of 10° or 15°
may be needed. A warning will be given if too many reflections are
being rejected as being too wide in phi.<br>

<br>

<span style="font-weight: bold;">Warning messages</span><br>

It is important to look at the warning messages, summarized in the
bottom right of the iMosflm GUI following an integration run. Clicking
on “warnings” will give a colour-coded summary and clicking on any of
these will result in a pop-up window that gives more details about the
warning and suggests possible improvements. It is particularly
important to check the warnings because the detector parameters (gain,
ADC offset and nullpix values) might not be known initially.<br>

<br>

<span style="font-weight: bold;">Space group determination, scaling and
merging</span><br>

The space group determination, scaling and merging can be determined
with the QuickSymm (POINTLESS) and QuickScale (AIMLESS) options as for
X-ray data. As the total rotation range for electron diffraction data
is physically limited by the rotation stage, and in addition there may
be radiation damage that further restricts the useful data, it may not
be possible to unambiguously assign the space group, particularly
determining whether a rotation axis is a pure rotation or a screw axis.
This will have to be achieved by merging data from several crystals.
The completeness of the data reported in the AIMLESS summary should be
compared with what is expected based on the Strategy option of iMosflm.
If it is significantly lower than expected, the following possible
causes should be checked and where appropriate the integration or the
scaling and merging should be repeated:<br>

<br>

i) Many reflections have been rejected during integration as outside
the active area because of an inappropriate value for nullpix. Check
the mosflm.lp file for this and if necessary change the nullpix value.<br>

<br>

ii) Many reflections have been rejected during integration as
“badspots”. Check the iMosflm warnings and/or the mosflm.lp file.<br>

<br>

iii) Many reflections have been rejected as outliers during the scaling
and merging. This could happen if the incorrect space group has been
chosen. Inspect the POINTLESS log file for evidence that the chosen
symmetry is incorrect and the ROGUES file written by AIMLESS may also
be informative.<br>

<br>

iv) Many reflections may have been rejected during scaling and merging
because the total fraction for summed, partially recorded reflections
lies outside the normal range (0.95-1.05). The listing in the AIMLESS
log file is:<br>

<br>

============================================================<br>

Handling of partials:<br>

MPART flags are checked<br>

Summed partials accepted if total fraction is between&nbsp; 0.95
&amp;&nbsp; 1.05<br>

<br>

123&nbsp; partial sets rejected with total fraction too small<br>

250&nbsp; partial sets rejected with total fraction too large<br>

0 partial sets rejected with gaps<br>

============================================================<br>

<br>

<br>

The summed fraction should theoretically be 1.0, but if there are any
errors in the crystal orientation it will differ from the theoretical
value. Because the crystal orientation is not defined as well for
electron diffraction data as for X-ray data, it may be necessary to
increase the allowed range, for example 0.80 to 1.20. These values can
be set in Settings -&gt; Processing options -&gt; Sort Scale and Merge
(Accept partials with total fraction between …).<br>

<br>

<br>

The statistics&nbsp; (Rmerge) for individual images should be used to
identify images that should be rejected (e.g. due to radiation damage).
These can be specified in Settings -&gt; Processing options -&gt; Sort
Scale and Merge (Accept partials with total fraction between …).<br>

<br>

<br>

<h1><a class="mozTocH1" name="mozTocId154054"></a>Appendix I</h1>

<p>A command script for running MOSFLM, using the keywords copied from
the "Batch" processing window of the new GUI (see <a href="#mozTocId178058">Integrating as a background job</a> §9.5.2).
Note that keyworded input for MOSFLM and other CCP4 programs is
case-insensitive apart from file and directory names.</p>

<p style="font-family: monospace;">#!/bin/csh -fv<br>
#<br>
# Set a unique identifier for filenames for this job<br>
#<br>
</p>

<p><span style="font-family: monospace;">set ident =
x89_mos07_blk3_smallsep</span><br style="font-family: monospace;">
<br style="font-family: monospace;">
<br style="font-family: monospace;">
<span style="font-family: monospace;">$mosflm COORDS {$ident}.coords \</span><br style="font-family: monospace;">
<span style="font-family: monospace;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
SUMMARY {$ident}.summary &lt;&lt; eof-ip</span><br style="font-family: monospace;">
<span style="font-family: monospace;">#</span><br style="font-family: monospace;">
<span style="font-family: monospace;"># Insert keywords copied from
iMosflm batch window here</span><br style="font-family: monospace;">
<span style="font-family: monospace;">#</span><br style="font-family: monospace;">
<br style="font-family: monospace;">
<span style="font-family: monospace;">#</span><br style="font-family: monospace;">
<span style="font-family: monospace;"># Keywords for this run</span><br style="font-family: monospace;">
<span style="font-family: monospace;"># For example, could involve
trying different values for mosaic spread,</span><br style="font-family: monospace;">
<span style="font-family: monospace;"># or not integrating all images
etc etc</span><br style="font-family: monospace;">
<span style="font-family: monospace;">#</span><br style="font-family: monospace;">
<span style="font-family: monospace;">hklout ${ident}.mtz</span><br style="font-family: monospace;">
<span style="font-family: monospace;">genfile ${ident}.gen</span><br style="font-family: monospace;">
<span style="font-family: monospace;">process 1 1000 </span><br style="font-family: monospace;">
<span style="font-family: monospace;">go</span><br style="font-family: monospace;">
<span style="font-family: monospace;">eof-ip</span><br style="font-family: monospace;">
<span style="font-family: monospace;"></span><br style="font-family: monospace;">
<span style="font-family: monospace;">pointless:</span><br style="font-family: monospace;">
<span style="font-family: monospace;">pointless hklin {$ident}.mtz \</span><br style="font-family: monospace;">
<span style="font-family: monospace;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
hklout {$ident}_pointless.mtz</span><br style="font-family: monospace;">
<br style="font-family: monospace;">
<span style="font-family: monospace;">aimless:</span><br style="font-family: monospace;">
<span style="font-family: monospace;">aimless hklin
{$ident}_pointless.mtz \</span><br style="font-family: monospace;">
<span style="font-family: monospace;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
hklout {$ident}_aimless_part.mtz \</span><br style="font-family: monospace;">
<span style="font-family: monospace;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
ROGUES {$ident}.rogues &lt;&lt; eof-aimless</span><br style="font-family: monospace;">
<span style="font-family: monospace;">#</span><br style="font-family: monospace;">
<span style="font-family: monospace;"># Use all default options for
aimless</span><br style="font-family: monospace;">
<span style="font-family: monospace;">#</span><br style="font-family: monospace;">
<span style="font-family: monospace;">eof-aimless</span><br style="font-family: monospace;">
<br style="font-family: monospace;">
<br style="font-family: monospace;">
<span style="font-family: monospace;">ctruncate hklin
{$ident}_aimless.mtz hklout {$ident}_truncate.mtz</span><br style="font-family: monospace;">
<br style="font-family: monospace;">
<br>
</p>

<p style="border-style: none none double; border-color: -moz-use-text-color -moz-use-text-color rgb(128, 128, 128); border-width: medium medium 1.1pt; padding: 0cm 0cm 0.05cm;">
<!--#include file="end_basic_frame.html" --><!-- <!-- hhmts end --2
</body> --><br>
<br>
</p>

<p><a href="mailto:mosflm@mrc-lmb.cam.ac.uk">Harry Powell</a>, <a href="mailto:mosflm@mrc-lmb.cam.ac.uk">Andrew
Leslie</a> and <a href="mailto:mosflm@mrc-lmb.cam.ac.uk">Owen Johnson</a></p>

<p><br>
<br>
</p>

</body></html>